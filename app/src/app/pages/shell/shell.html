<mat-sidenav-container class="shell-container" [class.sidebar-collapsed]="!sidenavExpanded()">
  <!-- Sidenav -->
  <mat-sidenav
    #sidenav
    [mode]="isMobile() ? 'over' : 'side'"
    [opened]="isMobile() ? sidenavOpen() : true"
    (openedChange)="isMobile() && sidenavOpen.set($event)"
    class="sidebar"
    [class.collapsed]="!isMobile() && !sidenavExpanded()"
    [class.mobile-expanded]="isMobile() && sidenavOpen()"
    [style.width]="isMobile() ? '280px' : (sidenavExpanded() ? '280px' : '72px')">
    
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <a routerLink="/" class="logo">
        <span class="logo-icon">G</span>
        <span class="logo-text">ylde</span>
      </a>
    </div>

    <!-- User Profile Section -->
    <div class="sidebar-profile-wrapper">
      <a 
        routerLink="/trust"
        class="sidebar-profile"
        (click)="onNavItemClick()"
        [matTooltip]="'Trust Score'"
        [matTooltipDisabled]="sidenavExpanded()"
        matTooltipPosition="right">
        <div class="profile-avatar">
          @if (userPhotoURL()) {
            <img [src]="userPhotoURL()" alt="Your profile" class="avatar-image">
          } @else {
            <span class="material-icons-outlined">person</span>
          }
        </div>
        <div class="profile-info">
          <span class="profile-name">{{ currentUser()?.displayName || 'Your Profile' }}</span>
          <div class="profile-completion-mini">
            <div class="completion-bar-mini">
              <div class="completion-fill-mini" [style.width.%]="trustScore()"></div>
            </div>
            <span class="completion-text">{{ trustScore() }}%</span>
          </div>
        </div>
      </a>
    </div>

    <!-- Sidebar Content (scrollable) -->
    <div class="sidebar-content">
      <!-- Navigation -->
      <nav class="sidebar-nav">
        @for (item of navItems; track item.id) {
          <a 
            class="nav-item"
            [routerLink]="item.path"
            routerLinkActive="active"
            (click)="onNavItemClick()"
            [matTooltip]="'DASHBOARD.NAV.' + item.labelKey | translate"
            [matTooltipDisabled]="sidenavExpanded()"
            matTooltipPosition="right">
            <span class="material-icons-outlined nav-icon">{{ item.icon }}</span>
            <span class="nav-label">{{ 'DASHBOARD.NAV.' + item.labelKey | translate }}</span>
            @if (item.id === 'messages' && messageUnreadCount() > 0) {
              <span class="nav-badge">{{ messageUnreadCount() }}</span>
            } @else if (item.id === 'matches' && matchesBadgeCount() > 0) {
              <span class="nav-badge">{{ matchesBadgeCount() }}</span>
            }
          </a>
        }
      </nav>

      <!-- Spacer that grows when activity is collapsed -->
      <div class="activity-spacer" [class.expanded]="!activityExpanded()"></div>

      <!-- Recent Activity -->
      <div class="sidebar-activity" [class.collapsed]="!activityExpanded()">
        <button type="button" class="activity-header" (click)="toggleActivitySection()">
          <span class="activity-title">{{ 'DASHBOARD.ACTIVITY_TITLE' | translate }}</span>
          @if (unreadActivityCount() > 0) {
            <span class="activity-badge">{{ unreadActivityCount() }}</span>
          }
          <span class="activity-toggle material-icons-outlined" [class.expanded]="activityExpanded()">
            expand_less
          </span>
        </button>

        <ul class="activity-list">
          @for (activity of recentActivity() | slice:0:20; track activity.id) {
            <button 
              type="button"
              class="activity-item" 
              [class.unread]="!activity.read"
              [matTooltip]="getActivityTooltip(activity)"
              matTooltipPosition="right"
              (click)="onActivityClick(activity)">
              <div class="activity-avatar">
                @if (activity.photo) {
                  <img [src]="activity.photo" [alt]="activity.name" class="activity-avatar-img">
                } @else {
                  <span class="material-icons-outlined avatar-placeholder">person</span>
                }
                <span class="activity-type-badge" [class]="'type-' + activity.type">
                  <span class="material-icons-outlined">
                    @switch (activity.type) {
                      @case ('match') { favorite }
                      @case ('message') { chat_bubble }
                      @case ('favorite') { star }
                      @case ('view') { visibility }
                      @case ('photo_access_request') { lock }
                      @case ('photo_access_granted') { lock_open }
                      @case ('photo_access_denied') { lock }
                    }
                  </span>
                </span>
              </div>
              <div class="activity-content">
                <span class="activity-text">
                  @switch (activity.type) {
                    @case ('match') { Matched with {{ activity.name }} }
                    @case ('message') { {{ activity.name }} messaged you }
                    @case ('favorite') { {{ activity.name }} favorited you }
                    @case ('view') { {{ activity.name }} viewed your profile }
                    @case ('photo_access_request') { {{ activity.name }} requested access to your private photos }
                    @case ('photo_access_granted') { {{ activity.name }} granted you access to their private photos }
                    @case ('photo_access_denied') { {{ activity.name }} denied your photo access request }
                  }
                </span>
                <span class="activity-time">{{ activity.timeAgo }}</span>
              </div>
            </button>
          } @empty {
            <li class="activity-empty"
              matTooltip="No activity"
              [matTooltipDisabled]="sidenavExpanded()"
              matTooltipPosition="right">
              <span class="material-icons-outlined">notifications_none</span>
              <span class="activity-empty-text">No activity yet</span>
            </li>
          }
        </ul>

        @if (unreadActivityCount() > 0) {
          <div class="activity-actions">
            <button 
              type="button" 
              class="mark-all-read-btn"
              (click)="markAllActivitiesAsRead()">
              <span class="material-icons-outlined">done_all</span>
              <span class="mark-all-text">Mark all read</span>
            </button>
          </div>
        }
      </div>
    </div>

    <!-- Collapse/Expand Button -->
    <div class="sidebar-collapse">
      <button 
        type="button" 
        class="collapse-btn" 
        (click)="isMobile() ? toggleSidenav() : toggleSidenavExpanded()"
        [matTooltip]="sidenavExpanded() ? 'Collapse sidebar' : 'Expand sidebar'"
        [matTooltipDisabled]="isMobile() || sidenavExpanded()"
        matTooltipPosition="right">
        <span class="material-icons-outlined">{{ (isMobile() || sidenavExpanded()) ? 'chevron_left' : 'chevron_right' }}</span>
        <span class="collapse-label">{{ sidenavExpanded() ? 'Collapse' : 'Expand' }}</span>
      </button>
    </div>
  </mat-sidenav>

  <!-- Main Content -->
  <mat-sidenav-content class="main-content">
    <!-- Mobile Header Bar (hidden when in active chat) -->
    @if (isMobile() && !isMessagesWithActiveChat()) {
      <div class="mobile-nav-bar">
        <button type="button" class="mobile-nav-toggle" (click)="toggleSidenav()" aria-label="Open menu">
          <span class="material-icons-outlined">{{ sidenavOpen() ? 'close' : 'menu' }}</span>
        </button>
        <span class="mobile-logo">Gylde</span>
        <button type="button" class="mobile-profile-btn" routerLink="/trust" (click)="onNavItemClick()">
          @if (userPhotoURL()) {
            <img [src]="userPhotoURL()" alt="Profile" class="mobile-avatar">
          } @else {
            <span class="material-icons-outlined">person</span>
          }
        </button>
      </div>
    }

    <!-- Router Outlet for Child Routes -->
    <div class="content-area">
      <router-outlet></router-outlet>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
