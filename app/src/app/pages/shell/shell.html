<mat-sidenav-container class="shell-container" [class.sidebar-collapsed]="!sidenavExpanded()">
  <!-- Sidenav -->
  <mat-sidenav
    #sidenav
    [mode]="isMobile() ? 'over' : 'side'"
    [opened]="isMobile() ? sidenavOpen() : true"
    (openedChange)="isMobile() && sidenavOpen.set($event)"
    class="sidebar"
    [class.collapsed]="!isMobile() && !sidenavExpanded()"
    [class.mobile-expanded]="isMobile() && sidenavOpen()"
    [style.width]="isMobile() ? '280px' : (sidenavExpanded() ? '280px' : '72px')">
    
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <a routerLink="/" class="logo">
        <span class="logo-icon">G</span>
        <span class="logo-text">ylde</span>
      </a>
    </div>

    <!-- User Profile Section -->
    <div class="sidebar-profile-wrapper">
      <a 
        routerLink="/progress"
        class="sidebar-profile"
        (click)="onNavItemClick({ id: 'progress', path: '/progress' })"
        [matTooltip]="'DASHBOARD.SIDEBAR.PROFILE_PROGRESS' | translate"
        [matTooltipDisabled]="sidenavExpanded()"
        matTooltipPosition="right">
        <div class="profile-avatar">
          @if (userPhotoURL()) {
            <img [src]="userPhotoURL()" [attr.alt]="'DASHBOARD.SIDEBAR.YOUR_PROFILE_ALT' | translate" class="avatar-image">
          } @else {
            <span class="material-icons-outlined">person</span>
          }
        </div>
        <div class="profile-info">
          <span class="profile-name">{{ currentUser()?.displayName || ('DASHBOARD.SIDEBAR.YOUR_PROFILE' | translate) }}</span>
          <div class="profile-completion-mini">
            <div class="completion-bar-mini">
              <div class="completion-fill-mini" [style.width.%]="profileProgress()"></div>
            </div>
            <span class="completion-text">{{ profileProgress() }}%</span>
          </div>
        </div>
      </a>
    </div>

    <!-- Sidebar Content (scrollable) -->
    <div class="sidebar-content">
      <!-- Navigation -->
      <nav class="sidebar-nav">
        @for (item of navItems; track item.id) {
          <a 
            class="nav-item"
            [routerLink]="item.path"
            routerLinkActive="active"
            (click)="onNavItemClick(item)"
            [matTooltip]="'DASHBOARD.NAV.' + item.labelKey | translate"
            [matTooltipDisabled]="sidenavExpanded()"
            matTooltipPosition="right">
            <span class="material-icons-outlined nav-icon">{{ item.icon }}</span>
            <span class="nav-label">{{ 'DASHBOARD.NAV.' + item.labelKey | translate }}</span>
            @if (item.id === 'messages' && messageUnreadCount() > 0) {
              <span class="nav-badge">{{ messageUnreadCount() }}</span>
            } @else if (item.id === 'matches' && matchesBadgeCount() > 0) {
              <span class="nav-badge">{{ matchesBadgeCount() }}</span>
            } @else if (item.id === 'feed' && showFeedSoonBadge()) {
              <span class="nav-badge coming-soon">{{ 'DASHBOARD.SIDEBAR.SOON_BADGE' | translate }}</span>
            }
          </a>
        }
      </nav>

      <!-- Spacer that grows when activity is collapsed -->
      <div class="activity-spacer" [class.expanded]="!activityExpanded()"></div>

      <!-- Recent Activity -->
      <div class="sidebar-activity" [class.collapsed]="!activityExpanded()">
        <button type="button" class="activity-header" (click)="toggleActivitySection()">
          <span class="activity-title">{{ 'DASHBOARD.ACTIVITY_TITLE' | translate }}</span>
          @if (unreadActivityCount() > 0) {
            <span class="activity-badge">{{ unreadActivityCount() }}</span>
          }
          <span class="activity-toggle material-icons-outlined" [class.expanded]="activityExpanded()">
            expand_less
          </span>
        </button>

        <ul class="activity-list">
          @for (activity of recentActivity() | slice:0:20; track activity.id) {
            <button 
              type="button"
              class="activity-item" 
              [class.unread]="!activity.read"
              [matTooltip]="getActivityTooltip(activity)"
              matTooltipPosition="right"
              (click)="onActivityClick(activity)">
              <div class="activity-avatar">
                @if (activity.photo) {
                  <img [src]="activity.photo" [alt]="activity.name" class="activity-avatar-img">
                } @else {
                  <span class="material-icons-outlined avatar-placeholder">person</span>
                }
                <span class="activity-type-badge" [class]="'type-' + activity.type">
                  <span class="material-icons-outlined">
                    @switch (activity.type) {
                      @case ('match') { favorite }
                      @case ('message') { chat_bubble }
                      @case ('favorite') { star }
                      @case ('view') { visibility }
                      @case ('photo_access_request') { lock }
                      @case ('photo_access_granted') { lock_open }
                      @case ('photo_access_denied') { lock }
                    }
                  </span>
                </span>
              </div>
              <div class="activity-content">
                <span class="activity-text">
                  @switch (activity.type) {
                    @case ('match') { {{ 'DASHBOARD.ACTIVITY.MATCH' | translate:{ name: activity.name } }} }
                    @case ('message') { {{ 'DASHBOARD.ACTIVITY.MESSAGE' | translate:{ name: activity.name } }} }
                    @case ('favorite') { {{ 'DASHBOARD.ACTIVITY.FAVORITE' | translate:{ name: activity.name } }} }
                    @case ('view') { {{ 'DASHBOARD.ACTIVITY.VIEW' | translate:{ name: activity.name } }} }
                    @case ('photo_access_request') { {{ 'DASHBOARD.ACTIVITY.PHOTO_ACCESS_REQUEST' | translate:{ name: activity.name } }} }
                    @case ('photo_access_granted') { {{ 'DASHBOARD.ACTIVITY.PHOTO_ACCESS_GRANTED' | translate:{ name: activity.name } }} }
                    @case ('photo_access_denied') { {{ 'DASHBOARD.ACTIVITY.PHOTO_ACCESS_DENIED' | translate:{ name: activity.name } }} }
                  }
                </span>
                <span class="activity-time">{{ activity.timeAgo }}</span>
              </div>
            </button>
          } @empty {
            <li class="activity-empty"
              [matTooltip]="'DASHBOARD.SIDEBAR.NO_ACTIVITY_TOOLTIP' | translate"
              [matTooltipDisabled]="sidenavExpanded()"
              matTooltipPosition="right">
              <span class="material-icons-outlined">notifications_none</span>
              <span class="activity-empty-text">{{ 'DASHBOARD.SIDEBAR.NO_ACTIVITY_YET' | translate }}</span>
            </li>
          }
        </ul>

        @if (unreadActivityCount() > 0) {
          <div class="activity-actions">
            <button 
              type="button" 
              class="mark-all-read-btn"
              (click)="markAllActivitiesAsRead()">
              <span class="material-icons-outlined">done_all</span>
              <span class="mark-all-text">{{ 'DASHBOARD.SIDEBAR.MARK_ALL_READ' | translate }}</span>
            </button>
          </div>
        }
      </div>
    </div>

    <!-- Sidebar Footer -->
    <div class="sidebar-footer">
      <!-- Founder Feedback Link (requires founder status + feature flag enabled) -->
      @if (showFounderReportIssue()) {
        <button 
          type="button" 
          class="founder-feedback-btn" 
          (click)="openFounderIssueDialog()"
          [matTooltip]="'DASHBOARD.SIDEBAR.REPORT_ISSUE_TOOLTIP' | translate"
          [matTooltipDisabled]="sidenavExpanded()"
          matTooltipPosition="right">
          <span class="material-icons-outlined">bug_report</span>
          <span class="feedback-label">{{ 'DASHBOARD.SIDEBAR.REPORT_ISSUE' | translate }}</span>
        </button>
      }

      <!-- Collapse/Expand Button -->
      <button 
        type="button" 
        class="collapse-btn" 
        (click)="isMobile() ? toggleSidenav() : toggleSidenavExpanded()"
        [matTooltip]="(sidenavExpanded() ? 'DASHBOARD.SIDEBAR.COLLAPSE_TOOLTIP' : 'DASHBOARD.SIDEBAR.EXPAND_TOOLTIP') | translate"
        [matTooltipDisabled]="isMobile() || sidenavExpanded()"
        matTooltipPosition="right">
        <span class="material-icons-outlined">{{ (isMobile() || sidenavExpanded()) ? 'chevron_left' : 'chevron_right' }}</span>
        <span class="collapse-label">{{ (sidenavExpanded() ? 'DASHBOARD.SIDEBAR.COLLAPSE' : 'DASHBOARD.SIDEBAR.EXPAND') | translate }}</span>
      </button>
    </div>
  </mat-sidenav>

  <!-- Main Content -->
  <mat-sidenav-content class="main-content">
    <!-- Mobile Header Bar (hidden when in active chat) -->
    @if (isMobile() && !isMessagesWithActiveChat()) {
      <div class="mobile-nav-bar">
        <button type="button" class="mobile-nav-toggle" (click)="toggleSidenav()" [attr.aria-label]="'DASHBOARD.SIDEBAR.OPEN_MENU_ARIA' | translate">
          <span class="material-icons-outlined">{{ sidenavOpen() ? 'close' : 'menu' }}</span>
        </button>
        <span class="mobile-logo">Gylde</span>
        <button type="button" class="mobile-profile-btn" routerLink="/progress" (click)="onNavItemClick({ id: 'progress', path: '/progress' })">
          @if (userPhotoURL()) {
            <img [src]="userPhotoURL()" [attr.alt]="'DASHBOARD.SIDEBAR.PROFILE_ALT' | translate" class="mobile-avatar">
          } @else {
            <span class="material-icons-outlined">person</span>
          }
        </button>
      </div>
    }

    <!-- Router Outlet for Child Routes -->
    <div class="content-area">
      <router-outlet></router-outlet>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
