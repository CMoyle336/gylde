<section class="discover-section" aria-labelledby="discover-heading">
  <!-- Header Bar with Filter/Sort Controls -->
  <div class="discover-header">
    <div class="header-left">
      <button 
        type="button" 
        class="filter-toggle-btn"
        [class.active]="showFilters()"
        (click)="toggleFilters()">
        <mat-icon>tune</mat-icon>
        <span>Filters</span>
        @if (activeFilterCount() > 0) {
          <span class="filter-count">{{ activeFilterCount() }}</span>
        }
      </button>

      <!-- Sort Dropdown -->
      <button 
        type="button" 
        class="sort-btn"
        [matMenuTriggerFor]="sortMenu">
        <mat-icon>sort</mat-icon>
        <span>{{ getSortLabel() }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>
      <mat-menu #sortMenu="matMenu">
        @for (option of sortOptions; track option.label) {
          <button 
            mat-menu-item 
            (click)="setSort(option.value)"
            [class.selected]="isSortActive(option.value)">
            {{ option.label }}
            @if (isSortActive(option.value)) {
              <mat-icon>check</mat-icon>
            }
          </button>
        }
      </mat-menu>
    </div>

    <div class="header-right">
      <!-- Refresh Button -->
      <button 
        type="button" 
        class="refresh-btn"
        (click)="refresh()"
        [disabled]="loading()"
        matTooltip="Refresh results">
        <mat-icon [class.spinning]="loading()">refresh</mat-icon>
      </button>

      <!-- Saved Views Dropdown -->
      <button 
        type="button" 
        class="views-btn"
        [matMenuTriggerFor]="viewsMenu">
        <mat-icon>bookmark</mat-icon>
        <span class="views-label">{{ activeView()?.name || 'Views' }}</span>
        <mat-icon class="dropdown-icon">expand_more</mat-icon>
      </button>
      <mat-menu #viewsMenu="matMenu">
        @if (savedViews().length > 0) {
          @for (view of savedViews(); track view.id) {
            <button mat-menu-item (click)="applyView(view)">
              <mat-icon>{{ view.isDefault ? 'star' : 'bookmark_border' }}</mat-icon>
              {{ view.name }}
            </button>
          }
          <mat-divider></mat-divider>
        }
        <button mat-menu-item (click)="openSaveViewDialog()">
          <mat-icon>add</mat-icon>
          Save Current View
        </button>
        @if (savedViews().length > 0) {
          <button mat-menu-item (click)="openManageViewsDialog()">
            <mat-icon>settings</mat-icon>
            Manage Views
          </button>
        }
      </mat-menu>

      <span class="results-count">
        @if (totalEstimate()) {
          {{ totalEstimate() }} results
        }
      </span>
    </div>
  </div>

  <!-- Filters Panel (Collapsible) -->
  @if (showFilters()) {
    <app-discover-filters
      [filters]="filters()"
      [connectionTypeOptions]="connectionTypeOptions"
      [ethnicityOptions]="ethnicityOptions"
      [relationshipStatusOptions]="relationshipStatusOptions"
      [childrenOptions]="childrenOptions"
      [smokerOptions]="smokerOptions"
      [drinkerOptions]="drinkerOptions"
      [educationOptions]="educationOptions"
      [heightOptions]="heightOptions"
      [incomeOptions]="incomeOptions"
      [supportOrientationOptions]="supportOrientationOptions"
      [distanceOptions]="distanceOptions"
      (filterChange)="onFilterChange($event)"
      (reset)="resetFilters()"
      (apply)="applyFilters()"
      [animate.enter]="'filter-enter'"
      [animate.leave]="'filter-leave'" />
  }

  <!-- Loading State -->
  @if (!initialized() || (loading() && profiles().length === 0)) {
    <!-- Skeleton Loading State -->
    <div class="profile-grid">
      @for (i of skeletonCards; track i) {
        <app-profile-card-skeleton />
      }
    </div>
  } @else if (profiles().length === 0) {
    <!-- Empty State (only shown after initialization) -->
    <div class="empty-state">
      <mat-icon class="empty-icon">search_off</mat-icon>
      <h3>No profiles found</h3>
      <p>Try adjusting your filters or check back later.</p>
      <button mat-stroked-button color="primary" (click)="resetFilters(); applyFilters()">
        <mat-icon>refresh</mat-icon>
        Reset Filters
      </button>
    </div>
  } @else {
    <!-- Profile Grid -->
    <div class="profile-grid">
      @for (profile of profiles(); track profile.uid) {
        <app-profile-card
          [profile]="profile"
          [isFavorited]="isFavorited(profile.uid)"
          (messageClick)="onMessageProfile($event)"
          (viewClick)="onViewProfile($event)"
          (favoriteClick)="onFavoriteProfile($event)" />
      }
    </div>

    <!-- Load More -->
    @if (hasMore()) {
      <div class="load-more">
        <button mat-stroked-button (click)="loadMore()" [disabled]="loading()">
          @if (loading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            Load More
          }
        </button>
      </div>
    }
  }
</section>

<!-- Save View Dialog -->
<app-save-view-dialog
  [isOpen]="showSaveViewDialog()"
  (save)="onSaveView($event)"
  (close)="closeSaveViewDialog()" />

<!-- Manage Views Dialog -->
<app-manage-views-dialog
  [isOpen]="showManageViewsDialog()"
  [views]="savedViews()"
  (setDefault)="setDefaultView($event)"
  (deleteView)="deleteView($event)"
  (close)="closeManageViewsDialog()" />
