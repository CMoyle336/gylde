<div class="step-header">
  <h1 class="step-title">{{ 'ONBOARDING.STEP_7.TITLE' | translate }}</h1>
  <p class="step-subtitle">{{ 'ONBOARDING.STEP_7.SUBTITLE' | translate }}</p>
</div>

<div class="info-box">
  <div class="info-box-title">
    <span class="material-icons-outlined">info</span>
    {{ 'ONBOARDING.STEP_7.PHOTO_REQUIREMENTS' | translate }}
  </div>
  <ul class="info-box-list">
    <li>
      <span class="material-icons-outlined">check</span>
      {{ 'ONBOARDING.STEP_7.PHOTO_REQ_1' | translate }}
    </li>
    <li>
      <span class="material-icons-outlined">check</span>
      {{ 'ONBOARDING.STEP_7.PHOTO_REQ_2' | translate }}
    </li>
    <li>
      <span class="material-icons-outlined">check</span>
      {{ 'ONBOARDING.STEP_7.PHOTO_REQ_3' | translate }}
    </li>
    <li>
      <span class="material-icons-outlined">check</span>
      {{ 'ONBOARDING.STEP_7.PHOTO_REQ_4' | translate }}
    </li>
  </ul>
</div>

@if (uploadError()) {
  <div class="error-message" role="alert">
    <span class="material-icons-outlined">error_outline</span>
    {{ uploadError() }}
  </div>
}

<div class="question-group" style="margin-top: 2rem;">
  <div class="photo-grid">
    <!-- Primary Photo Slot -->
    <div class="photo-slot primary">
      @if (photoPreviews().length > 0) {
        <img [src]="photoPreviews()[0].preview" alt="Primary photo" class="photo-preview">
        <div class="photo-badge primary-badge">
          <span class="material-icons-outlined">star</span>
          {{ 'ONBOARDING.STEP_7.PROFILE_PHOTO' | translate }}
        </div>
        <button 
          type="button" 
          class="photo-remove" 
          (click)="removePhoto(0)"
          aria-label="Remove photo">
          <span class="material-icons-outlined">close</span>
        </button>
      } @else if (uploadingPhotos().length > 0 && photoPreviews().length === 0) {
        <!-- Primary photo is uploading -->
        <div class="photo-uploading-slot">
          <img [src]="uploadingPhotos()[0].preview" alt="Uploading" class="photo-preview uploading">
          <div class="upload-overlay-onboarding">
            @if (uploadingPhotos()[0].status === 'uploading') {
              <span class="upload-spinner"></span>
              <span class="upload-label">Uploading...</span>
            } @else if (uploadingPhotos()[0].status === 'error') {
              <span class="material-icons-outlined error-icon">error</span>
              <span class="upload-label error">{{ uploadingPhotos()[0].error || 'Failed' }}</span>
            }
          </div>
        </div>
      } @else {
        <label class="photo-upload-btn">
          <input 
            type="file" 
            accept="image/jpeg,image/jpg,image/png"
            (change)="onFileSelected($event, true)"
            style="display: none;">
          <span class="material-icons-outlined">add_a_photo</span>
          <span>{{ 'ONBOARDING.STEP_7.PRIMARY_PHOTO' | translate }}</span>
        </label>
      }
    </div>

    <!-- Additional Photo Slots -->
    @for (photo of photoPreviews().slice(1); track $index) {
      <div class="photo-slot">
        <img [src]="photo.preview" alt="Photo {{ $index + 2 }}" class="photo-preview">
        <button 
          type="button" 
          class="photo-set-primary"
          (click)="setAsPrimary($index + 1)"
          aria-label="Set as profile photo"
          title="Set as profile photo">
          <span class="material-icons-outlined">star_outline</span>
        </button>
        <button 
          type="button" 
          class="photo-remove" 
          (click)="removePhoto($index + 1)"
          aria-label="Remove photo">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>
    }

    <!-- Uploading Photos (after first one if primary exists) -->
    @for (uploading of (photoPreviews().length > 0 ? uploadingPhotos() : uploadingPhotos().slice(1)); track uploading.id) {
      <div class="photo-slot uploading-slot" [class.error]="uploading.status === 'error'">
        <img [src]="uploading.preview" alt="Uploading" class="photo-preview uploading">
        <div class="upload-overlay-onboarding">
          @if (uploading.status === 'uploading') {
            <span class="upload-spinner"></span>
            <span class="upload-label">Uploading...</span>
          } @else if (uploading.status === 'error') {
            <span class="material-icons-outlined error-icon">error</span>
            <span class="upload-label error">{{ uploading.error || 'Failed' }}</span>
          }
        </div>
      </div>
    }

    <!-- Add Photo Button -->
    @if (photoPreviews().length > 0 && (photoPreviews().length + uploadingPhotos().length) < maxPhotos) {
      <div class="photo-slot">
        <label class="photo-upload-btn">
          <input 
            type="file" 
            accept="image/jpeg,image/jpg,image/png"
            multiple
            (change)="onFilesSelected($event)"
            style="display: none;">
          <span class="material-icons-outlined">add</span>
          <span>{{ 'ONBOARDING.STEP_7.ADD_PHOTO' | translate }}</span>
        </label>
      </div>
    }
  </div>

  <p class="question-hint" style="margin-top: 1rem; text-align: center;">
    {{ 'ONBOARDING.STEP_7.SUPPORTED_FORMATS' | translate }}
  </p>
</div>
