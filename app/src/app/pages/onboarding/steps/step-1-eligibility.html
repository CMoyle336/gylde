<div class="step-header">
  <h1 class="step-title">{{ 'ONBOARDING.STEP_1.TITLE' | translate }}</h1>
  <p class="step-subtitle">{{ 'ONBOARDING.STEP_1.SUBTITLE' | translate }}</p>
</div>

<div class="question-group">
  <span class="question-label">{{ 'ONBOARDING.STEP_1.BIRTHDAY_QUESTION' | translate }}</span>
  <span class="question-hint">{{ 'ONBOARDING.STEP_1.BIRTHDAY_HINT' | translate }}</span>
  
  <div class="input-wrapper birthday-wrapper">
    <input 
      type="text"
      class="input-field"
      [matDatepicker]="picker"
      [min]="minBirthDate"
      [max]="maxBirthDate"
      [value]="birthDateValue()"
      (dateChange)="onBirthDateChange($event.value)"
      (click)="picker.open()"
      (focus)="picker.open()"
      [placeholder]="'ONBOARDING.STEP_1.BIRTHDAY_LABEL' | translate"
      readonly>
    <button type="button" class="datepicker-toggle" (click)="picker.open()">
      <span class="material-icons-outlined">calendar_today</span>
    </button>
    <mat-datepicker #picker [startAt]="maxBirthDate" startView="multi-year"></mat-datepicker>
  </div>

  @if (userAge !== null) {
    <div class="age-display" [class.valid]="isAdult" [class.invalid]="!isAdult">
      <span class="material-icons-outlined">{{ isAdult ? 'check_circle' : 'error_outline' }}</span>
      @if (isAdult) {
        <span>{{ 'ONBOARDING.STEP_1.AGE_VERIFIED' | translate: { age: userAge } }}</span>
      } @else {
        <span>{{ 'ONBOARDING.STEP_1.AGE_REQUIRED' | translate }}</span>
      }
    </div>
  }
</div>

@if (isAdult) {
  <div class="question-group">
    <span class="question-label">{{ 'ONBOARDING.STEP_1.LOCATION_QUESTION' | translate }}</span>
    
    <!-- Region Restriction Notice (only shown when US is the only allowed region) -->
    @if (showUsOnlyNotice()) {
      <div class="region-notice">
        <span class="material-icons-outlined">public</span>
        <span>Gylde is currently available in the United States only.</span>
      </div>
    }
    
    <!-- Location Status Banner -->
    @if (locationStatus() !== 'idle') {
      <div class="location-status" [class]="locationStatus()">
        @switch (locationStatus()) {
          @case ('detecting') {
            <span class="location-spinner"></span>
            <span>{{ 'ONBOARDING.STEP_1.LOCATION_DETECTING' | translate }}</span>
          }
          @case ('success') {
            <span class="material-icons-outlined">check_circle</span>
            <span>{{ locationMessage() || ('ONBOARDING.STEP_1.LOCATION_SUCCESS' | translate) }}</span>
          }
          @case ('error') {
            <span class="material-icons-outlined">error_outline</span>
            <span>{{ locationMessage() }}</span>
            <button type="button" class="retry-btn" (click)="retryGeolocation()">
              {{ 'ONBOARDING.STEP_1.LOCATION_RETRY' | translate }}
            </button>
          }
          @case ('manual') {
            <span class="material-icons-outlined">edit_location</span>
            <span>{{ locationMessage() }}</span>
            <button type="button" class="retry-btn" (click)="retryGeolocation()">
              {{ 'ONBOARDING.STEP_1.LOCATION_USE_GPS' | translate }}
            </button>
          }
        }
      </div>
    }

    <!-- City Autocomplete Input -->
    <div class="autocomplete-wrapper">
      <div class="input-wrapper">
        <span class="input-icon material-icons-outlined">location_on</span>
        <input 
          #cityInput
          type="text" 
          class="input-field with-icon"
          [class.searching]="isSearching()"
          [placeholder]="'ONBOARDING.STEP_1.CITY_AUTOCOMPLETE_PLACEHOLDER' | translate"
          [value]="cityInputValue()"
          (input)="onInputChange($any($event.target).value)"
          (keydown)="onKeyDown($event)"
          (focus)="onInputFocus()"
          autocomplete="off"
          role="combobox"
          aria-autocomplete="list"
          [attr.aria-expanded]="showSuggestions()"
          aria-haspopup="listbox">
        @if (isSearching()) {
          <span class="input-spinner"></span>
        }
      </div>
      
      <!-- Autocomplete Suggestions Dropdown -->
      @if (showSuggestions()) {
        <ul class="suggestions-list" role="listbox">
          @for (suggestion of suggestions(); track suggestion.placeId; let i = $index) {
            <li 
              class="suggestion-item"
              [class.highlighted]="highlightedIndex() === i"
              role="option"
              [attr.aria-selected]="highlightedIndex() === i"
              (click)="selectSuggestion(suggestion)"
              (mouseenter)="highlightedIndex.set(i)">
              <span class="suggestion-icon material-icons-outlined">place</span>
              <span class="suggestion-text">
                <span class="suggestion-main">{{ suggestion.mainText }}</span>
                <span class="suggestion-secondary">{{ suggestion.secondaryText }}</span>
              </span>
            </li>
          }
        </ul>
      }
    </div>
  </div>
}
