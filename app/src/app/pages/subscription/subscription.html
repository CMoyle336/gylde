<div class="subscription-page">
  <!-- Loading Overlay -->
  @if (loading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Redirecting to checkout...</p>
    </div>
  }

  <!-- Success Message -->
  @if (successMessage()) {
    <div class="message-banner success">
      <mat-icon>check_circle</mat-icon>
      <span>{{ successMessage() }}</span>
      <button class="dismiss-btn" (click)="dismissSuccess()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  <!-- Error Message -->
  @if (error()) {
    <div class="message-banner error">
      <mat-icon>error</mat-icon>
      <span>{{ error() }}</span>
      <button class="dismiss-btn" (click)="dismissError()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  <!-- Pending Cancellation Notice -->
  @if (pendingCancellation(); as cancellation) {
    <div class="message-banner warning">
      <mat-icon>cancel</mat-icon>
      <span>
        Your <strong>{{ getPlanName(cancellation.currentTier) }}</strong> subscription will end on {{ cancellation.formattedDate }}.
        You'll keep your features until then.
      </span>
    </div>
  }

  <!-- Pending Downgrade Notice -->
  @if (pendingDowngrade(); as pending) {
    <div class="message-banner info">
      <mat-icon>schedule</mat-icon>
      <span>
        Your plan will change to <strong>{{ getPlanName(pending.tier) }}</strong> on {{ pending.formattedDate }}.
        You'll keep your current features until then.
      </span>
    </div>
  }

  <!-- Header -->
  <header class="subscription-header">
    <button class="back-btn" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-content">
      <h1>Choose Your Plan</h1>
      <p>Unlock the full Gylde experience</p>
    </div>
    @if (hasActiveSubscription()) {
      <button class="manage-btn" (click)="manageSubscription()">
        <mat-icon>settings</mat-icon>
        Manage
      </button>
    }
  </header>

  <!-- Billing Toggle -->
  <div class="billing-toggle">
    <button 
      class="toggle-option" 
      [class.active]="billingPeriod() === 'monthly'"
      (click)="billingPeriod.set('monthly')">
      Monthly
    </button>
    <button 
      class="toggle-option" 
      [class.active]="billingPeriod() === 'quarterly'"
      (click)="billingPeriod.set('quarterly')">
      3 Months
      <span class="savings-badge">Save {{ savingsPercent() }}%</span>
    </button>
  </div>

  <!-- Plans Grid -->
  <div class="plans-grid">
    @for (plan of plans; track plan.id) {
      <div 
        class="plan-card" 
        [class.highlighted]="plan.highlighted"
        [class.current]="isCurrentPlan(plan.id)">
        
        @if (plan.highlighted) {
          <div class="popular-badge">Most Popular</div>
        }

        <div class="plan-header">
          <div class="plan-icon">
            <mat-icon>{{ plan.badge }}</mat-icon>
          </div>
          <h2 class="plan-name">{{ plan.name }}</h2>
          <p class="plan-tagline">{{ plan.tagline }}</p>
        </div>

        <div class="plan-price">
          <span class="price-amount">{{ getPrice(plan) }}</span>
          <span class="price-period">{{ getBillingLabel(plan) }}</span>
        </div>

        <ul class="plan-features">
          @for (feature of plan.features; track feature.id) {
            <li [class.included]="feature.included" [class.highlight]="feature.highlight">
              <mat-icon>{{ feature.included ? 'check_circle' : 'cancel' }}</mat-icon>
              <span>{{ feature.label }}</span>
            </li>
          }
        </ul>

        <button 
          class="plan-cta"
          [class.current]="isCurrentPlan(plan.id)"
          [class.upgrade]="canUpgrade(plan.id)"
          [disabled]="isCurrentPlan(plan.id)"
          (click)="selectPlan(plan)">
          {{ getButtonLabel(plan.id) }}
        </button>
      </div>
    }
  </div>

  <!-- FAQ / Info Section -->
  <div class="info-section">
    <div class="info-card">
      <mat-icon>security</mat-icon>
      <div>
        <h3>Secure Payments</h3>
        <p>All transactions are processed securely through Stripe.</p>
      </div>
    </div>
    <div class="info-card">
      <mat-icon>autorenew</mat-icon>
      <div>
        <h3>Cancel Anytime</h3>
        <p>No commitment. Cancel your subscription at any time.</p>
      </div>
    </div>
    <div class="info-card">
      <mat-icon>support_agent</mat-icon>
      <div>
        <h3>24/7 Support</h3>
        <p>Our support team is here to help whenever you need.</p>
      </div>
    </div>
  </div>
</div>
