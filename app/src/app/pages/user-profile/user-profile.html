<div class="user-profile-page">
  @if (loading()) {
    <app-profile-skeleton />
  } @else if (error()) {
    <div class="error-state">
      <mat-icon class="error-icon">person_off</mat-icon>
      <h2>{{ error() }}</h2>
      <p class="error-hint">This profile may be private or no longer exists.</p>
    </div>
  } @else if (profile(); as profile) {
    <div class="profile-content">
      <!-- Left Column: Photos + Stats -->
      <div class="left-column">
        <!-- Photo Gallery -->
        <section class="photo-section">
        <div class="main-photo">
          @if (profilePhoto()) {
            <img [src]="profilePhoto()" [alt]="profile.displayName || 'Profile photo'">
            @if (isCurrentPhotoPrivate() && photoAccess().hasAccess) {
              <div class="private-photo-badge">
                <mat-icon>lock</mat-icon>
                <span>Private</span>
              </div>
            }
          } @else {
            <div class="photo-placeholder">
              <mat-icon>person</mat-icon>
            </div>
          }

          <!-- Photo Navigation -->
          @if (orderedPhotos().length > 1) {
            <button class="photo-nav prev" mat-icon-button (click)="prevPhoto()">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="photo-nav next" mat-icon-button (click)="nextPhoto()">
              <mat-icon>chevron_right</mat-icon>
            </button>

            <!-- Photo Indicators -->
            <div class="photo-indicators">
              @for (photo of orderedPhotos(); track photo; let i = $index) {
                <button 
                  class="indicator" 
                  [class.active]="i === selectedPhotoIndex()"
                  (click)="selectPhoto(i)">
                </button>
              }
            </div>
          }

          </div>

        <!-- Thumbnail Strip -->
        @if (orderedPhotos().length > 1) {
          <div class="photo-thumbnails">
            @for (photo of orderedPhotos(); track photo; let i = $index) {
              <button 
                class="thumbnail" 
                [class.active]="i === selectedPhotoIndex()"
                [class.is-private]="isPhotoPrivate(photo) && photoAccess().hasAccess"
                (click)="selectPhoto(i)">
                <img [src]="photo" [alt]="'Photo ' + (i + 1)" loading="lazy">
                @if (isPhotoPrivate(photo) && photoAccess().hasAccess) {
                  <div class="thumbnail-private-badge">
                    <mat-icon>lock</mat-icon>
                  </div>
                }
              </button>
            }
          </div>
        }
        
        <!-- Private Photos Notice -->
        @if (hasHiddenPrivatePhotos()) {
          <div class="private-photos-notice">
            <div class="notice-content">
              <mat-icon>lock</mat-icon>
              <div class="notice-text">
                <span class="notice-title">{{ privatePhotoCount() }} private photo{{ privatePhotoCount() > 1 ? 's' : '' }}</span>
                @if (getAccessStatusText()) {
                  <span class="notice-status">{{ getAccessStatusText() }}</span>
                } @else {
                  <span class="notice-hint">Request access to view</span>
                }
              </div>
            </div>
            @if (!photoAccess().requestStatus) {
              <button 
                mat-stroked-button 
                color="primary"
                class="request-access-btn"
                [disabled]="requestingAccess()"
                (click)="requestPhotoAccess()">
                @if (requestingAccess()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <ng-container>
                    <mat-icon>vpn_key</mat-icon>
                    Request Access
                  </ng-container>
                }
              </button>
            } @else if (photoAccess().requestStatus === 'pending') {
              <button 
                mat-stroked-button 
                class="cancel-request-btn"
                [disabled]="requestingAccess()"
                (click)="cancelPhotoAccessRequest()">
                @if (requestingAccess()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  Cancel Request
                }
              </button>
            } @else if (photoAccess().requestStatus === 'denied') {
              <button 
                mat-stroked-button 
                class="request-again-btn"
                [disabled]="requestingAccess()"
                (click)="requestPhotoAccess()">
                @if (requestingAccess()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <ng-container>
                    <mat-icon>refresh</mat-icon>
                    Request Again
                  </ng-container>
                }
              </button>
            }
          </div>
        }
      </section>

      <!-- Profile Stats (separate section for mobile reordering) -->
      <section class="stats-section">
        <div class="profile-stats">
          @if (lastViewedMe()) {
            <div class="stat-item highlight">
              <mat-icon>visibility</mat-icon>
              <div class="stat-content">
                <span class="stat-label">Viewed your profile</span>
                <span class="stat-value">{{ formatLastViewedMe() }}</span>
              </div>
            </div>
          }
          <div class="stat-item">
            <mat-icon>schedule</mat-icon>
            <div class="stat-content">
              <span class="stat-label">Last active</span>
              <span class="stat-value" [class.online]="isOnline()">
                @if (isOnline()) {
                  Online now
                } @else if (getLastActive()) {
                  {{ getLastActive() }}
                } @else {
                  Unknown
                }
              </span>
            </div>
          </div>
          <div class="stat-item">
            <mat-icon>cake</mat-icon>
            <div class="stat-content">
              <span class="stat-label">Member since</span>
              <span class="stat-value">{{ formatProfileAge() }}</span>
            </div>
          </div>
          <div class="stat-item" [class.verified]="profile.isVerified">
            <mat-icon>{{ profile.isVerified ? 'verified' : 'shield' }}</mat-icon>
            <div class="stat-content">
              <span class="stat-label">Verification</span>
              <span class="stat-value">{{ profile.isVerified ? 'Verified' : 'Not verified' }}</span>
            </div>
          </div>
        </div>
      </section>
      </div>

      <!-- Profile Info -->
      <section class="info-section">
        <!-- Header with Name & Actions -->
        <div class="profile-header">
          <div class="name-location">
            <h1 class="profile-name">
              {{ profile.displayName || 'Anonymous' }}
              @if (age()) {
                <span class="age">, {{ age() }}</span>
              }
            </h1>
            @if (profile.settings?.privacy?.showLocation !== false && profile.onboarding?.city; as city) {
              <div class="location">
                <mat-icon>location_on</mat-icon>
                {{ city }}, {{ profile.onboarding?.country }}
              </div>
            }
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button 
              mat-flat-button
              color="primary" 
              class="message-btn"
              (click)="onMessage()">
              <mat-icon>chat_bubble</mat-icon>
              Message
            </button>
            <button 
              class="icon-btn favorite-btn"
              [class.favorited]="isFavorited()"
              (click)="onFavorite()"
              [matTooltip]="isFavorited() ? 'Remove from favorites' : 'Add to favorites'">
              <mat-icon>{{ isFavorited() ? 'favorite' : 'favorite_border' }}</mat-icon>
            </button>
            <button class="icon-btn" [matMenuTriggerFor]="moreMenu" matTooltip="More options">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #moreMenu="matMenu">
              <button mat-menu-item (click)="onReport()">
                <mat-icon>flag</mat-icon>
                Report User
              </button>
              <button mat-menu-item (click)="onBlock()">
                <mat-icon>block</mat-icon>
                Block User
              </button>
            </mat-menu>
          </div>
        </div>

        <!-- My Ideal Relationship -->
        <div class="profile-block">
          <h3>My Ideal Relationship</h3>
          @if (profile.onboarding?.idealRelationship) {
            <p class="about-text">{{ profile.onboarding?.idealRelationship }}</p>
          } @else {
            <p class="empty-placeholder">Not specified</p>
          }
        </div>

        <!-- What Support Means -->
        <div class="profile-block">
          <h3>What Support Means to Me</h3>
          @if (profile.onboarding?.supportMeaning) {
            <p class="about-text">{{ profile.onboarding?.supportMeaning }}</p>
          } @else {
            <p class="empty-placeholder">Not specified</p>
          }
        </div>

        <!-- Looking For -->
        <div class="profile-block">
          <h3>Looking For</h3>
          @if (profile.onboarding?.connectionTypes?.length) {
            <div class="tag-list">
              @for (type of profile.onboarding?.connectionTypes || []; track type) {
                <span class="tag accent">{{ formatConnectionTypes([type]) }}</span>
              }
            </div>
          } @else {
            <p class="empty-placeholder">Not specified</p>
          }
        </div>

        <!-- Personal Details -->
        <div class="profile-block details-grid">
          <h3>Details</h3>
          <div class="details">
            <div class="detail-item">
              <span class="detail-label">Gender</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.genderIdentity">
                {{ formatGender(profile.onboarding?.genderIdentity) || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Height</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.height">
                {{ profile.onboarding?.height || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Weight</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.weight">
                {{ profile.onboarding?.weight || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Ethnicity</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.ethnicity">
                {{ profile.onboarding?.ethnicity || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Relationship Status</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.relationshipStatus">
                {{ profile.onboarding?.relationshipStatus || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Children</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.children">
                {{ profile.onboarding?.children || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Education</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.education">
                {{ profile.onboarding?.education || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Occupation</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.occupation">
                {{ profile.onboarding?.occupation || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Smoking</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.smoker">
                {{ profile.onboarding?.smoker || 'Not specified' }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Drinking</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.drinker">
                {{ profile.onboarding?.drinker || 'Not specified' }}
              </span>
            </div>
          </div>
        </div>
      </section>
    </div>
  }
</div>
