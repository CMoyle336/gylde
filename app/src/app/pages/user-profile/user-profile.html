<div class="user-profile-page">
  @if (loading()) {
    <app-profile-skeleton />
  } @else if (error()) {
    <div class="error-state">
      <mat-icon class="error-icon">person_off</mat-icon>
      <h2>{{ error() | translate }}</h2>
      <p class="error-hint">{{ 'USER_PROFILE.ERROR_HINT' | translate }}</p>
    </div>
  } @else if (profile(); as profile) {
    <div class="profile-content">
      <!-- Left Column: Photos + Stats -->
      <div class="left-column">
        <!-- Photo Gallery -->
        <section class="photo-section">
        <div class="main-photo">
          @if (profilePhoto()) {
            <img [src]="profilePhoto()" [attr.alt]="profile.displayName || ('USER_PROFILE.PROFILE_PHOTO_ALT' | translate)">
            @if (isCurrentPhotoPrivate() && photoAccess().hasAccess) {
              <div class="private-photo-badge">
                <mat-icon>lock</mat-icon>
                <span>{{ 'USER_PROFILE.PRIVATE_BADGE' | translate }}</span>
              </div>
            }
          } @else {
            <div class="photo-placeholder">
              <mat-icon>person</mat-icon>
            </div>
          }

          <!-- Photo Navigation -->
          @if (orderedPhotos().length > 1) {
            <button class="photo-nav prev" mat-icon-button (click)="prevPhoto()">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <button class="photo-nav next" mat-icon-button (click)="nextPhoto()">
              <mat-icon>chevron_right</mat-icon>
            </button>

            <!-- Photo Indicators -->
            <div class="photo-indicators">
              @for (photo of orderedPhotos(); track photo; let i = $index) {
                <button 
                  class="indicator" 
                  [class.active]="i === selectedPhotoIndex()"
                  (click)="selectPhoto(i)">
                </button>
              }
            </div>
          }

          </div>

        <!-- Thumbnail Strip -->
        @if (orderedPhotos().length > 1) {
          <div class="photo-thumbnails">
            @for (photo of orderedPhotos(); track photo; let i = $index) {
              <button 
                class="thumbnail" 
                [class.active]="i === selectedPhotoIndex()"
                [class.is-private]="isPhotoPrivate(photo) && photoAccess().hasAccess"
                (click)="selectPhoto(i)">
                <img [src]="photo" [attr.alt]="'USER_PROFILE.PHOTO_ALT' | translate:{ index: i + 1 }" loading="lazy">
                @if (isPhotoPrivate(photo) && photoAccess().hasAccess) {
                  <div class="thumbnail-private-badge">
                    <mat-icon>lock</mat-icon>
                  </div>
                }
              </button>
            }
          </div>
        }
        
        <!-- Private Photos Notice -->
        @if (hasHiddenPrivatePhotos()) {
          <div class="private-photos-notice">
            <div class="notice-content">
              <mat-icon>lock</mat-icon>
              <div class="notice-text">
                <span class="notice-title">
                  {{ privatePhotoCount() }}
                  {{ (privatePhotoCount() === 1 ? 'USER_PROFILE.PRIVATE_PHOTO' : 'USER_PROFILE.PRIVATE_PHOTOS') | translate }}
                </span>
                @if (getAccessStatusText()) {
                  <span class="notice-status">{{ getAccessStatusText() }}</span>
                } @else {
                  <span class="notice-hint">{{ 'USER_PROFILE.REQUEST_ACCESS_HINT' | translate }}</span>
                }
              </div>
            </div>
            @if (!photoAccess().requestStatus) {
              <button 
                mat-stroked-button 
                color="primary"
                class="request-access-btn"
                [disabled]="requestingAccess()"
                (click)="requestPhotoAccess()">
                @if (requestingAccess()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <ng-container>
                    <mat-icon>vpn_key</mat-icon>
                    {{ 'USER_PROFILE.REQUEST_ACCESS_BUTTON' | translate }}
                  </ng-container>
                }
              </button>
            } @else if (photoAccess().requestStatus === 'pending') {
              <button 
                mat-stroked-button 
                class="cancel-request-btn"
                [disabled]="requestingAccess()"
                (click)="cancelPhotoAccessRequest()">
                @if (requestingAccess()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  {{ 'USER_PROFILE.CANCEL_REQUEST_BUTTON' | translate }}
                }
              </button>
            } @else if (photoAccess().requestStatus === 'denied') {
              <button 
                mat-stroked-button 
                class="request-again-btn"
                [disabled]="requestingAccess()"
                (click)="requestPhotoAccess()">
                @if (requestingAccess()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <ng-container>
                    <mat-icon>refresh</mat-icon>
                    {{ 'USER_PROFILE.REQUEST_AGAIN_BUTTON' | translate }}
                  </ng-container>
                }
              </button>
            }
          </div>
        }
      </section>

      <!-- Profile Stats (separate section for mobile reordering) -->
      <section class="stats-section">
        <div class="profile-stats">
          @if (lastViewedMe()) {
            <div class="stat-item highlight">
              <mat-icon>visibility</mat-icon>
              <div class="stat-content">
                <span class="stat-label">{{ 'USER_PROFILE.VIEWED_YOUR_PROFILE' | translate }}</span>
                <span class="stat-value">{{ formatLastViewedMe() }}</span>
              </div>
            </div>
          }
          <div class="stat-item">
            <mat-icon>schedule</mat-icon>
            <div class="stat-content">
              <span class="stat-label">{{ 'USER_PROFILE.LAST_ACTIVE_LABEL' | translate }}</span>
              <span class="stat-value" [class.online]="isOnline()">
                @if (isOnline()) {
                  {{ 'USER_PROFILE.ONLINE_NOW' | translate }}
                } @else if (getLastActive()) {
                  {{ getLastActive() }}
                } @else {
                  {{ 'USER_PROFILE.UNKNOWN' | translate }}
                }
              </span>
            </div>
          </div>
          <div class="stat-item">
            <mat-icon>cake</mat-icon>
            <div class="stat-content">
              <span class="stat-label">{{ 'USER_PROFILE.MEMBER_SINCE_LABEL' | translate }}</span>
              <span class="stat-value">{{ formatProfileAge() }}</span>
            </div>
          </div>
          <div class="stat-item" [class.verified]="profile.identityVerified">
            <mat-icon>{{ profile.identityVerified ? 'verified' : 'shield' }}</mat-icon>
            <div class="stat-content">
              <span class="stat-label">{{ 'USER_PROFILE.VERIFICATION_LABEL' | translate }}</span>
              <span class="stat-value">{{ profile.identityVerified ? ('USER_PROFILE.VERIFIED' | translate) : ('USER_PROFILE.NOT_VERIFIED' | translate) }}</span>
            </div>
          </div>
        </div>
      </section>
      </div>

      <!-- Profile Info -->
      <section class="info-section">
        <!-- Header with Name & Actions -->
        <div class="profile-header">
          <div class="name-location">
            <div class="name-row">
              <h1 class="profile-name">
                {{ profile.displayName || ('USER_PROFILE.ANONYMOUS_NAME' | translate) }}
                @if (age()) {
                  <span class="age">, {{ age() }}</span>
                }
              </h1>
              <!-- Badges: Founder + Identity Verified + Reputation -->
              <div class="profile-badges">
                @if (profile.isFounder) {
                  <app-founder-badge [city]="profile.founderCity" size="medium" />
                }
                @if (profile.identityVerified) {
                  <span class="verified-badge" [matTooltip]="'USER_PROFILE.IDENTITY_VERIFIED_TOOLTIP' | translate">
                    <mat-icon>verified</mat-icon>
                  </span>
                }
                @if (showReputationBadge()) {
                  <app-reputation-badge 
                    [tier]="reputationTier()" 
                    mode="badge" 
                    size="medium"
                    [matTooltip]="reputationDisplay().description" />
                }
              </div>
            </div>
            @if (profile.settings?.privacy?.showLocation !== false && profile.onboarding?.city; as city) {
              <div class="location">
                <mat-icon>location_on</mat-icon>
                {{ city }}, {{ profile.onboarding?.country }}
              </div>
            }
            @if (profile.onboarding?.tagline; as tagline) {
              <p class="profile-tagline">{{ tagline }}</p>
            }
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button 
              mat-flat-button
              color="primary" 
              class="message-btn"
              [disabled]="messagingLoading()"
              (click)="onMessage()">
              @if (messagingLoading()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <mat-icon>chat_bubble</mat-icon>
              }
              {{ 'USER_PROFILE.MESSAGE_BUTTON' | translate }}
            </button>
            <button 
              class="icon-btn favorite-btn"
              [class.favorited]="isFavorited()"
              (click)="onFavorite()"
              [matTooltip]="(isFavorited() ? 'USER_PROFILE.REMOVE_FAVORITE_TOOLTIP' : 'USER_PROFILE.ADD_FAVORITE_TOOLTIP') | translate">
              <mat-icon>{{ isFavorited() ? 'favorite' : 'favorite_border' }}</mat-icon>
            </button>
            <button class="icon-btn" [matMenuTriggerFor]="moreMenu" [matTooltip]="'USER_PROFILE.MORE_OPTIONS_TOOLTIP' | translate">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #moreMenu="matMenu">
              <button mat-menu-item (click)="onReport()">
                <mat-icon>flag</mat-icon>
                {{ 'USER_PROFILE.REPORT_USER_MENU' | translate }}
              </button>
              <button mat-menu-item (click)="openBlockDialog()">
                <mat-icon>block</mat-icon>
                {{ 'USER_PROFILE.BLOCK_USER_MENU' | translate }}
              </button>
            </mat-menu>
          </div>
        </div>

        <!-- My Ideal Relationship -->
        <div class="profile-block">
          <h3>{{ 'USER_PROFILE.IDEAL_RELATIONSHIP_TITLE' | translate }}</h3>
          @if (profile.onboarding?.idealRelationship) {
            <p class="about-text">{{ profile.onboarding?.idealRelationship }}</p>
          } @else {
            <p class="empty-placeholder">{{ 'USER_PROFILE.NOT_SPECIFIED' | translate }}</p>
          }
        </div>

        <!-- What Support Means -->
        <div class="profile-block">
          <h3>{{ 'USER_PROFILE.SUPPORT_MEANING_TITLE' | translate }}</h3>
          @if (profile.onboarding?.supportMeaning) {
            <p class="about-text">{{ profile.onboarding?.supportMeaning }}</p>
          } @else {
            <p class="empty-placeholder">{{ 'USER_PROFILE.NOT_SPECIFIED' | translate }}</p>
          }
        </div>

        <!-- Looking For -->
        <div class="profile-block">
          <h3>{{ 'USER_PROFILE.LOOKING_FOR_TITLE' | translate }}</h3>
          @if (profile.onboarding?.connectionTypes?.length) {
            <div class="tag-list">
              @for (type of profile.onboarding?.connectionTypes || []; track type) {
                <span class="tag accent">{{ formatConnectionTypes([type]) }}</span>
              }
            </div>
          } @else {
            <p class="empty-placeholder">{{ 'USER_PROFILE.NOT_SPECIFIED' | translate }}</p>
          }
        </div>

        <!-- Support Orientation -->
        <div class="profile-block">
          <h3>{{ 'USER_PROFILE.SUPPORT_ORIENTATION_TITLE' | translate }}</h3>
          @if (profile.onboarding?.supportOrientation) {
            <div class="tag-list">
              <span class="tag">{{ formatSupportOrientation(profile.onboarding?.supportOrientation) }}</span>
            </div>
          } @else {
            <p class="empty-placeholder">{{ 'USER_PROFILE.NOT_SPECIFIED' | translate }}</p>
          }
        </div>

        <!-- Personal Details -->
        <div class="profile-block details-grid">
          <h3>{{ 'USER_PROFILE.DETAILS_TITLE' | translate }}</h3>
          <div class="details">
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.GENDER' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.genderIdentity">
                {{ formatGender(profile.onboarding?.genderIdentity) || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.HEIGHT' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.height">
                {{ profile.onboarding?.height || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.WEIGHT' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.weight">
                {{ profile.onboarding?.weight || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.ETHNICITY' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.ethnicity">
                {{ profile.onboarding?.ethnicity || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.RELATIONSHIP_STATUS' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.relationshipStatus">
                {{ profile.onboarding?.relationshipStatus || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.CHILDREN' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.children">
                {{ profile.onboarding?.children || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.EDUCATION' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.education">
                {{ profile.onboarding?.education || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.OCCUPATION' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.occupation">
                {{ profile.onboarding?.occupation || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.INCOME' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.income">
                {{ profile.onboarding?.income || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.SMOKING' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.smoker">
                {{ profile.onboarding?.smoker || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'USER_PROFILE.DETAIL.DRINKING' | translate }}</span>
              <span class="detail-value" [class.empty]="!profile.onboarding?.drinker">
                {{ profile.onboarding?.drinker || ('USER_PROFILE.NOT_SPECIFIED' | translate) }}
              </span>
            </div>
          </div>
        </div>
      </section>
    </div>
  }
</div>

