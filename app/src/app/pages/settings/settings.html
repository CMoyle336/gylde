<div class="settings-page">
  <header class="settings-header">
    <h1>{{ 'SETTINGS.TITLE' | translate }}</h1>
    <p>{{ 'SETTINGS.SUBTITLE' | translate }}</p>
  </header>

  <div class="settings-content">
    <!-- Subscription Section -->
    <section class="settings-section subscription-section">
      <div class="section-header">
        <mat-icon>workspace_premium</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.SUBSCRIPTION.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.SUBSCRIPTION.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="subscription-status">
          <div class="current-plan">
            <div class="plan-badge" [class.premium]="subscriptionService.isPremium()">
              <mat-icon>{{ subscriptionService.getTierBadge(subscriptionService.currentTier()) }}</mat-icon>
              <span class="plan-name">{{ subscriptionService.getTierDisplayName(subscriptionService.currentTier()) }}</span>
            </div>
            <span class="plan-status">
              @if (subscriptionService.isPremium()) {
                @if (subscriptionService.pendingCancellation(); as cancellation) {
                  Cancels {{ cancellation.formattedDate }}
                } @else {
                  Active subscription
                }
              } @else {
                Free plan
              }
            </span>
          </div>
          <button 
            class="manage-btn" 
            (click)="handleSubscriptionAction()"
            [class.upgrade]="!subscriptionService.isPremium()">
            @if (subscriptionService.isPremium()) {
              Manage Plan
            } @else {
              Upgrade
            }
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </section>

    <!-- Privacy Settings -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>lock</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.PRIVACY.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.PRIVACY.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.ONLINE_STATUS' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.ONLINE_STATUS_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.showOnlineStatus ?? true"
            (change)="updateSetting('privacy', 'showOnlineStatus', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.LAST_ACTIVE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.LAST_ACTIVE_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.showLastActive ?? true"
            (change)="updateSetting('privacy', 'showLastActive', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.PROFILE_VISIBILITY' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.PROFILE_VISIBILITY_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.profileVisible ?? true"
            (change)="updateSetting('privacy', 'profileVisible', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.SHOW_LOCATION' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.SHOW_LOCATION_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.showLocation ?? true"
            (change)="updateSetting('privacy', 'showLocation', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACTIVITY.VIEW_NOTIFICATIONS' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACTIVITY.VIEW_NOTIFICATIONS_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().activity?.createOnView ?? true"
            (change)="updateSetting('activity', 'createOnView', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACTIVITY.FAVORITE_NOTIFICATIONS' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACTIVITY.FAVORITE_NOTIFICATIONS_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().activity?.createOnFavorite ?? true"
            (change)="updateSetting('activity', 'createOnFavorite', $event.checked)">
          </mat-slide-toggle>
        </div>
      </div>
    </section>

    <!-- Notification Settings -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>notifications</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.NOTIFICATIONS.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.NOTIFICATIONS.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MATCHES' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MATCHES_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.emailMatches ?? true"
            (change)="updateSetting('notifications', 'emailMatches', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MESSAGES' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MESSAGES_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.emailMessages ?? true"
            (change)="updateSetting('notifications', 'emailMessages', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_FAVORITES' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_FAVORITES_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.emailFavorites ?? true"
            (change)="updateSetting('notifications', 'emailFavorites', $event.checked)">
          </mat-slide-toggle>
        </div>

      </div>
    </section>

    <!-- Preferences -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>tune</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.PREFERENCES.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.PREFERENCES.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PREFERENCES.LANGUAGE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PREFERENCES.LANGUAGE_DESC' | translate }}</span>
          </div>
          <mat-form-field appearance="outline" class="setting-select">
            <mat-select
              [value]="settings().preferences?.language ?? 'en'"
              (selectionChange)="updateSetting('preferences', 'language', $event.value)">
              <mat-option value="en">English</mat-option>
              <mat-option value="nl">Nederlands</mat-option>
              <mat-option value="de">Deutsch</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PREFERENCES.DARK_MODE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PREFERENCES.DARK_MODE_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="isDarkMode()"
            (change)="themeService.toggleTheme()">
          </mat-slide-toggle>
        </div>
      </div>
    </section>

    <!-- Account Settings -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>person</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.ACCOUNT.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.ACCOUNT.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item clickable" (click)="openChangeEmail()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACCOUNT.EMAIL' | translate }}</span>
            <span class="setting-description email-description">
              @if (userEmail()) {
                @if (isEmailVerified()) {
                  <span class="email-verified">
                    <mat-icon class="verified-icon">verified</mat-icon>
                    {{ userEmail() }}
                  </span>
                } @else {
                  <span class="email-unverified">
                    {{ userEmail() }}
                    <span class="unverified-badge">{{ 'SETTINGS.ACCOUNT.UNVERIFIED' | translate }}</span>
                  </span>
                }
              } @else {
                {{ 'SETTINGS.ACCOUNT.NOT_SET' | translate }}
              }
            </span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>

        @if (userEmail() && !isEmailVerified()) {
          <div class="setting-item clickable verify-email-item" (click)="openVerifyEmail()">
            <div class="setting-info">
              <span class="setting-label">{{ 'SETTINGS.ACCOUNT.VERIFY_EMAIL' | translate }}</span>
              <span class="setting-description">{{ 'SETTINGS.ACCOUNT.VERIFY_EMAIL_DESC' | translate }}</span>
            </div>
            <mat-icon class="chevron action-icon">mail</mat-icon>
          </div>
        }

        <div class="setting-item clickable" (click)="openPhoneDialog()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACCOUNT.PHONE' | translate }}</span>
            <span class="setting-description phone-description">
              @if (userPhoneNumber()) {
                <span class="phone-verified">
                  <mat-icon class="verified-icon">verified</mat-icon>
                  {{ userPhoneNumber() }}
                </span>
              } @else {
                {{ 'SETTINGS.ACCOUNT.PHONE_DESC' | translate }}
              }
            </span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>

        <div class="setting-item clickable" (click)="openResetPassword()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACCOUNT.PASSWORD' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACCOUNT.PASSWORD_DESC' | translate }}</span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>

        <div class="setting-item clickable" (click)="openLogoutDialog()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACCOUNT.LOGOUT' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACCOUNT.LOGOUT_DESC' | translate }}</span>
          </div>
          <mat-icon class="chevron logout-icon">logout</mat-icon>
        </div>
      </div>
    </section>

    <!-- Blocked Users -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>block</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.BLOCKED.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.BLOCKED.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item clickable" (click)="openBlockedUsersDialog()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.BLOCKED.MANAGE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.BLOCKED.MANAGE_DESC' | translate }}</span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="settings-section danger-zone">
      <div class="section-header">
        <mat-icon>warning</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.DANGER.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.DANGER.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        @if (isAccountDisabled()) {
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-label">{{ 'SETTINGS.DANGER.DISABLED' | translate }}</span>
              <span class="setting-description">{{ 'SETTINGS.DANGER.DISABLED_DESC' | translate }}</span>
            </div>
            <button mat-stroked-button color="primary" (click)="enableAccount()">
              {{ 'SETTINGS.DANGER.ENABLE' | translate }}
            </button>
          </div>
        } @else {
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-label">{{ 'SETTINGS.DANGER.DISABLE' | translate }}</span>
              <span class="setting-description">{{ 'SETTINGS.DANGER.DISABLE_DESC' | translate }}</span>
            </div>
            <button mat-stroked-button color="warn" (click)="disableAccount()">
              {{ 'SETTINGS.DANGER.DISABLE' | translate }}
            </button>
          </div>
        }

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.DANGER.DELETE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.DANGER.DELETE_DESC' | translate }}</span>
          </div>
          <button mat-stroked-button color="warn" (click)="openDeleteAccount()">
            {{ 'SETTINGS.DANGER.DELETE' | translate }}
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Saving indicator -->
  @if (saving()) {
    <div class="saving-indicator">
      <mat-spinner diameter="20"></mat-spinner>
      <span>{{ 'SETTINGS.SAVING' | translate }}</span>
    </div>
  }
</div>

<!-- Change Email Dialog -->
@if (showChangeEmailDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.CHANGE_EMAIL_TITLE' | translate }}</h3>
      
      @if (!dialogSuccess()) {
        <p>{{ 'SETTINGS.DIALOGS.CHANGE_EMAIL_DESC' | translate }}</p>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'SETTINGS.DIALOGS.NEW_EMAIL' | translate }}</mat-label>
          <input matInput type="email" [(ngModel)]="newEmail" placeholder="you@example.com">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'SETTINGS.DIALOGS.CURRENT_PASSWORD' | translate }}</mat-label>
          <input matInput type="password" [(ngModel)]="currentPassword">
        </mat-form-field>
      }

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      @if (dialogSuccess()) {
        <p class="success-message">{{ dialogSuccess() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">
          {{ dialogSuccess() ? ('SETTINGS.DIALOGS.CLOSE' | translate) : ('SETTINGS.DIALOGS.CANCEL' | translate) }}
        </button>
        @if (!dialogSuccess()) {
          <button mat-flat-button color="primary" (click)="changeEmail()" [disabled]="dialogLoading()">
            @if (dialogLoading()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              {{ 'SETTINGS.DIALOGS.CHANGE_EMAIL' | translate }}
            }
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- Reset Password Dialog -->
@if (showResetPasswordDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.RESET_PASSWORD_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.RESET_PASSWORD_DESC' | translate }}</p>
      
      <p class="email-display">{{ userEmail() }}</p>

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      @if (dialogSuccess()) {
        <p class="success-message">{{ dialogSuccess() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="primary" (click)="sendPasswordReset()" [disabled]="dialogLoading() || dialogSuccess()">
          @if (dialogLoading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            {{ 'SETTINGS.DIALOGS.SEND_RESET' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Account Dialog -->
@if (showDeleteAccountDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog delete-dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.DELETE_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.DELETE_DESC' | translate }}</p>
      
      <div class="warning-box danger">
        <mat-icon>warning</mat-icon>
        <div class="delete-warning-content">
          <strong>This action is permanent and cannot be undone.</strong>
          <ul class="delete-list">
            <li>Your profile and all photos will be deleted</li>
            <li>All your messages and conversations will be deleted</li>
            <li>Your matches and favorites will be removed</li>
            <li>Your account will be permanently removed</li>
            @if (subscriptionService.isPremium()) {
              <li><strong>Your premium subscription will be canceled immediately</strong></li>
            }
          </ul>
        </div>
      </div>

      <p class="delete-confirm-instruction">
        Type <strong>DELETE MY ACCOUNT</strong> to confirm:
      </p>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Type confirmation</mat-label>
        <input matInput [(ngModel)]="deleteConfirmation" placeholder="DELETE MY ACCOUNT" autocomplete="off">
      </mat-form-field>

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="warn" (click)="deleteAccount()" 
                [disabled]="dialogLoading() || deleteConfirmation !== 'DELETE MY ACCOUNT'">
          @if (dialogLoading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            {{ 'SETTINGS.DIALOGS.DELETE_BUTTON' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Disable Account Dialog -->
@if (showDisableAccountDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.DISABLE_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.DISABLE_DESC' | translate }}</p>
      
      <div class="warning-box info">
        <mat-icon>info</mat-icon>
        <span>{{ 'SETTINGS.DIALOGS.DISABLE_INFO' | translate }}</span>
      </div>

      @if (subscriptionService.isPremium()) {
        <div class="warning-box warning">
          <mat-icon>credit_card</mat-icon>
          <span>Your premium subscription will be canceled at the end of your current billing period. 
            If you re-enable your account before then, your subscription will remain active.</span>
        </div>
      }

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="warn" (click)="confirmDisableAccount()" 
                [disabled]="dialogLoading()">
          @if (dialogLoading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            {{ 'SETTINGS.DIALOGS.DISABLE_BUTTON' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Logout Confirmation Dialog -->
@if (showLogoutDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog logout-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-icon">
        <mat-icon>logout</mat-icon>
      </div>
      <h3>{{ 'SETTINGS.DIALOGS.LOGOUT_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.LOGOUT_DESC' | translate }}</p>
      
      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="warn" (click)="confirmLogout()">
          {{ 'SETTINGS.DIALOGS.LOGOUT_BUTTON' | translate }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Phone Verification Dialog -->
@if (showPhoneDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog phone-dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.PHONE_TITLE' | translate }}</h3>
      
      @if (phoneVerificationStep() === 'input') {
        <div class="phone-privacy-notice">
          <mat-icon>lock</mat-icon>
          <p>{{ 'SETTINGS.DIALOGS.PHONE_PRIVACY' | translate }}</p>
        </div>

        <div class="phone-benefit">
          <mat-icon>phonelink_lock</mat-icon>
          <p>{{ 'SETTINGS.DIALOGS.PHONE_BENEFIT' | translate }}</p>
        </div>
        
        <div class="phone-input-wrapper">
          <label class="phone-input-label">{{ 'SETTINGS.DIALOGS.PHONE_LABEL' | translate }}</label>
          <input 
            #phoneInput
            type="tel" 
            class="phone-input"
            [(ngModel)]="phoneNumber"
            [disabled]="dialogLoading()"
            (keydown)="onPhoneInputKeydown($event)">
          <span class="phone-input-hint">{{ 'SETTINGS.DIALOGS.PHONE_HINT' | translate }}</span>
        </div>

        <!-- Invisible reCAPTCHA container -->
        <div id="recaptcha-container"></div>
      }

      @if (phoneVerificationStep() === 'verify') {
        <p class="code-sent-message">
          {{ 'SETTINGS.DIALOGS.CODE_SENT' | translate }} <strong>{{ phoneNumber }}</strong>
        </p>

        <div class="verification-code-input">
          <label class="code-label">{{ 'SETTINGS.DIALOGS.VERIFICATION_CODE' | translate }}</label>
          <div class="code-digits">
            @for (digit of codeDigits(); track $index; let i = $index) {
              <input
                #codeInput
                type="text"
                inputmode="numeric"
                pattern="[0-9]"
                maxlength="1"
                class="digit-input"
                [class.has-value]="digit !== ''"
                [value]="digit"
                [disabled]="dialogLoading()"
                (input)="onDigitInput($event, i)"
                (keydown)="onDigitKeydown($event, i)"
                (paste)="onCodePaste($event)"
                (focus)="onDigitFocus(i)"
                autocomplete="one-time-code">
            }
          </div>
        </div>

        <button mat-button class="resend-btn" (click)="resendCode()" [disabled]="dialogLoading()">
          {{ 'SETTINGS.DIALOGS.RESEND_CODE' | translate }}
        </button>
      }

      @if (phoneVerificationStep() === 'success') {
        <div class="success-state">
          <mat-icon class="success-icon">check_circle</mat-icon>
          <p>{{ 'SETTINGS.DIALOGS.PHONE_VERIFIED' | translate }}</p>
        </div>
      }

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">
          {{ phoneVerificationStep() === 'success' ? ('SETTINGS.DIALOGS.CLOSE' | translate) : ('SETTINGS.DIALOGS.CANCEL' | translate) }}
        </button>
        
        @if (phoneVerificationStep() === 'input') {
          <button 
            mat-flat-button 
            color="primary" 
            id="send-code-btn"
            (click)="sendVerificationCode()" 
            [disabled]="dialogLoading()">
            @if (dialogLoading()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              {{ 'SETTINGS.DIALOGS.SEND_CODE' | translate }}
            }
          </button>
        }

        @if (phoneVerificationStep() === 'verify' && dialogLoading()) {
          <div class="verifying-indicator">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Verifying...</span>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Verify Email Dialog -->
@if (showVerifyEmailDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.VERIFY_EMAIL_TITLE' | translate }}</h3>
      
      @if (!dialogSuccess()) {
        <p>{{ 'SETTINGS.DIALOGS.VERIFY_EMAIL_DESC' | translate }}</p>
        <p class="email-display">{{ userEmail() }}</p>
      }

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      @if (dialogSuccess()) {
        <div class="success-state">
          <mat-icon class="success-icon">mark_email_read</mat-icon>
          <p>{{ dialogSuccess() }}</p>
        </div>
      }

      <div class="dialog-actions">
        @if (dialogSuccess()) {
          <button mat-flat-button color="primary" (click)="closeDialogs()">
            {{ 'SETTINGS.DIALOGS.CLOSE' | translate }}
          </button>
        } @else {
          <button mat-button (click)="closeDialogs()">
            {{ 'SETTINGS.DIALOGS.CANCEL' | translate }}
          </button>
          <button mat-flat-button color="primary" (click)="sendEmailVerification()" [disabled]="dialogLoading()">
            @if (dialogLoading()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              {{ 'SETTINGS.DIALOGS.SEND_VERIFICATION' | translate }}
            }
          </button>
        }
      </div>
    </div>
  </div>
}

