<div class="settings-page">
  <header class="settings-header">
    <h1>{{ 'SETTINGS.TITLE' | translate }}</h1>
    <p>{{ 'SETTINGS.SUBTITLE' | translate }}</p>
  </header>

  <div class="settings-content">
    <!-- Privacy Settings -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>lock</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.PRIVACY.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.PRIVACY.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.ONLINE_STATUS' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.ONLINE_STATUS_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.showOnlineStatus ?? true"
            (change)="updateSetting('privacy', 'showOnlineStatus', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.LAST_ACTIVE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.LAST_ACTIVE_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.showLastActive ?? true"
            (change)="updateSetting('privacy', 'showLastActive', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.PROFILE_VISIBILITY' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.PROFILE_VISIBILITY_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.profileVisible ?? true"
            (change)="updateSetting('privacy', 'profileVisible', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PRIVACY.SHOW_LOCATION' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PRIVACY.SHOW_LOCATION_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().privacy?.showLocation ?? true"
            (change)="updateSetting('privacy', 'showLocation', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACTIVITY.VIEW_NOTIFICATIONS' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACTIVITY.VIEW_NOTIFICATIONS_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().activity?.createOnView ?? true"
            (change)="updateSetting('activity', 'createOnView', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACTIVITY.FAVORITE_NOTIFICATIONS' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACTIVITY.FAVORITE_NOTIFICATIONS_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().activity?.createOnFavorite ?? true"
            (change)="updateSetting('activity', 'createOnFavorite', $event.checked)">
          </mat-slide-toggle>
        </div>
      </div>
    </section>

    <!-- Notification Settings -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>notifications</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.NOTIFICATIONS.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.NOTIFICATIONS.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MATCHES' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MATCHES_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.emailMatches ?? true"
            (change)="updateSetting('notifications', 'emailMatches', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MESSAGES' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_MESSAGES_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.emailMessages ?? true"
            (change)="updateSetting('notifications', 'emailMessages', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_FAVORITES' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.EMAIL_FAVORITES_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.emailFavorites ?? true"
            (change)="updateSetting('notifications', 'emailFavorites', $event.checked)">
          </mat-slide-toggle>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.NOTIFICATIONS.PUSH' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.NOTIFICATIONS.PUSH_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="settings().notifications?.pushEnabled ?? false"
            (change)="updateSetting('notifications', 'pushEnabled', $event.checked)">
          </mat-slide-toggle>
        </div>
      </div>
    </section>

    <!-- Preferences -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>tune</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.PREFERENCES.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.PREFERENCES.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PREFERENCES.LANGUAGE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PREFERENCES.LANGUAGE_DESC' | translate }}</span>
          </div>
          <mat-form-field appearance="outline" class="setting-select">
            <mat-select
              [value]="settings().preferences?.language ?? 'en'"
              (selectionChange)="updateSetting('preferences', 'language', $event.value)">
              <mat-option value="en">English</mat-option>
              <mat-option value="nl">Nederlands</mat-option>
              <mat-option value="de">Deutsch</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.PREFERENCES.DARK_MODE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.PREFERENCES.DARK_MODE_DESC' | translate }}</span>
          </div>
          <mat-slide-toggle
            [checked]="isDarkMode()"
            (change)="themeService.toggleTheme()">
          </mat-slide-toggle>
        </div>
      </div>
    </section>

    <!-- Account Settings -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>person</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.ACCOUNT.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.ACCOUNT.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item clickable" (click)="openChangeEmail()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACCOUNT.EMAIL' | translate }}</span>
            <span class="setting-description">{{ userEmail() || 'Not set' }}</span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>

        <div class="setting-item clickable" (click)="openResetPassword()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.ACCOUNT.PASSWORD' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.ACCOUNT.PASSWORD_DESC' | translate }}</span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>
      </div>
    </section>

    <!-- Blocked Users -->
    <section class="settings-section">
      <div class="section-header">
        <mat-icon>block</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.BLOCKED.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.BLOCKED.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        <div class="setting-item clickable" (click)="openBlockedUsersDialog()">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.BLOCKED.MANAGE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.BLOCKED.MANAGE_DESC' | translate }}</span>
          </div>
          <mat-icon class="chevron">chevron_right</mat-icon>
        </div>
      </div>
    </section>

    <!-- Danger Zone -->
    <section class="settings-section danger-zone">
      <div class="section-header">
        <mat-icon>warning</mat-icon>
        <div>
          <h2>{{ 'SETTINGS.DANGER.TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.DANGER.SUBTITLE' | translate }}</p>
        </div>
      </div>

      <div class="settings-group">
        @if (isAccountDisabled()) {
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-label">{{ 'SETTINGS.DANGER.DISABLED' | translate }}</span>
              <span class="setting-description">{{ 'SETTINGS.DANGER.DISABLED_DESC' | translate }}</span>
            </div>
            <button mat-stroked-button color="primary" (click)="enableAccount()">
              {{ 'SETTINGS.DANGER.ENABLE' | translate }}
            </button>
          </div>
        } @else {
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-label">{{ 'SETTINGS.DANGER.DISABLE' | translate }}</span>
              <span class="setting-description">{{ 'SETTINGS.DANGER.DISABLE_DESC' | translate }}</span>
            </div>
            <button mat-stroked-button color="warn" (click)="disableAccount()">
              {{ 'SETTINGS.DANGER.DISABLE' | translate }}
            </button>
          </div>
        }

        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">{{ 'SETTINGS.DANGER.DELETE' | translate }}</span>
            <span class="setting-description">{{ 'SETTINGS.DANGER.DELETE_DESC' | translate }}</span>
          </div>
          <button mat-stroked-button color="warn" (click)="openDeleteAccount()">
            {{ 'SETTINGS.DANGER.DELETE' | translate }}
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Saving indicator -->
  @if (saving()) {
    <div class="saving-indicator">
      <mat-spinner diameter="20"></mat-spinner>
      <span>{{ 'SETTINGS.SAVING' | translate }}</span>
    </div>
  }
</div>

<!-- Change Email Dialog -->
@if (showChangeEmailDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.CHANGE_EMAIL_TITLE' | translate }}</h3>
      
      @if (!dialogSuccess()) {
        <p>{{ 'SETTINGS.DIALOGS.CHANGE_EMAIL_DESC' | translate }}</p>
        
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'SETTINGS.DIALOGS.NEW_EMAIL' | translate }}</mat-label>
          <input matInput type="email" [(ngModel)]="newEmail" placeholder="you@example.com">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'SETTINGS.DIALOGS.CURRENT_PASSWORD' | translate }}</mat-label>
          <input matInput type="password" [(ngModel)]="currentPassword">
        </mat-form-field>
      }

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      @if (dialogSuccess()) {
        <p class="success-message">{{ dialogSuccess() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">
          {{ dialogSuccess() ? ('SETTINGS.DIALOGS.CLOSE' | translate) : ('SETTINGS.DIALOGS.CANCEL' | translate) }}
        </button>
        @if (!dialogSuccess()) {
          <button mat-flat-button color="primary" (click)="changeEmail()" [disabled]="dialogLoading()">
            @if (dialogLoading()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              {{ 'SETTINGS.DIALOGS.CHANGE_EMAIL' | translate }}
            }
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- Reset Password Dialog -->
@if (showResetPasswordDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.RESET_PASSWORD_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.RESET_PASSWORD_DESC' | translate }}</p>
      
      <p class="email-display">{{ userEmail() }}</p>

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      @if (dialogSuccess()) {
        <p class="success-message">{{ dialogSuccess() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="primary" (click)="sendPasswordReset()" [disabled]="dialogLoading() || dialogSuccess()">
          @if (dialogLoading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            {{ 'SETTINGS.DIALOGS.SEND_RESET' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Account Dialog -->
@if (showDeleteAccountDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog delete-dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.DELETE_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.DELETE_DESC' | translate }}</p>
      
      <div class="warning-box">
        <mat-icon>warning</mat-icon>
        <span>{{ 'SETTINGS.DIALOGS.DELETE_CONFIRM' | translate }}</span>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Confirmation</mat-label>
        <input matInput [(ngModel)]="deleteConfirmation" placeholder="DELETE">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ 'SETTINGS.DIALOGS.CURRENT_PASSWORD' | translate }}</mat-label>
        <input matInput type="password" [(ngModel)]="currentPassword">
      </mat-form-field>

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="warn" (click)="deleteAccount()" 
                [disabled]="dialogLoading() || deleteConfirmation !== 'DELETE'">
          @if (dialogLoading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            {{ 'SETTINGS.DIALOGS.DELETE_BUTTON' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Disable Account Dialog -->
@if (showDisableAccountDialog()) {
  <div class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog" (click)="$event.stopPropagation()">
      <h3>{{ 'SETTINGS.DIALOGS.DISABLE_TITLE' | translate }}</h3>
      <p>{{ 'SETTINGS.DIALOGS.DISABLE_DESC' | translate }}</p>
      
      <div class="warning-box info">
        <mat-icon>info</mat-icon>
        <span>{{ 'SETTINGS.DIALOGS.DISABLE_INFO' | translate }}</span>
      </div>

      @if (dialogError()) {
        <p class="error-message">{{ dialogError() }}</p>
      }

      <div class="dialog-actions">
        <button mat-button (click)="closeDialogs()">{{ 'SETTINGS.DIALOGS.CANCEL' | translate }}</button>
        <button mat-flat-button color="warn" (click)="confirmDisableAccount()" 
                [disabled]="dialogLoading()">
          @if (dialogLoading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            {{ 'SETTINGS.DIALOGS.DISABLE_BUTTON' | translate }}
          }
        </button>
      </div>
    </div>
  </div>
}
