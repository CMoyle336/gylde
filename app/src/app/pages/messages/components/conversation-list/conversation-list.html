<aside class="conversation-list" [class.hidden-on-mobile]="activeConversation">
  <!-- Unified Header with Filters -->
  <div class="list-header">
    <div class="header-row">
      <h2>Chats</h2>
      @if (totalUnreadCount > 0) {
        <span class="header-badge">{{ totalUnreadCount }}</span>
      }
    </div>
    <div class="filter-row">
      <div class="filter-dropdown">
        <mat-icon class="filter-icon">{{ getStatusIcon() }}</mat-icon>
        <mat-select 
          [value]="conversationFilter"
          (selectionChange)="onFilterChange($event.value)"
          panelClass="chat-filter-panel">
          <mat-option value="all">
            <mat-icon>chat_bubble_outline</mat-icon>
            <span>All chats</span>
          </mat-option>
          <mat-option value="unread">
            <mat-icon>mark_email_unread</mat-icon>
            <span>Unread</span>
            @if (totalUnreadCount > 0) {
              <span class="option-badge">{{ totalUnreadCount }}</span>
            }
          </mat-option>
          <mat-option value="archived">
            <mat-icon>inventory_2</mat-icon>
            <span>Archived</span>
            @if (archivedCount > 0) {
              <span class="option-badge muted">{{ archivedCount }}</span>
            }
          </mat-option>
        </mat-select>
      </div>
      <div class="filter-dropdown" [class.has-filter]="reputationFilter">
        <mat-icon class="filter-icon" [style.color]="getActiveReputationColor()">{{ getActiveReputationIcon() }}</mat-icon>
        <mat-select 
          [value]="reputationFilter || ''"
          (selectionChange)="onReputationSelectChange($event.value)"
          panelClass="chat-filter-panel reputation-filter-panel">
          <mat-option value="">
            <mat-icon>people</mat-icon>
            <span>Any member</span>
          </mat-option>
          @for (tier of tierFilterOptions; track tier.value) {
            @if (tier.value) {
              <mat-option [value]="tier.value">
                <mat-icon [style.color]="tier.color">{{ tier.icon }}</mat-icon>
                <span>{{ tier.label }}</span>
              </mat-option>
            }
          }
        </mat-select>
      </div>
    </div>
  </div>

  <!-- Conversation List -->
  <div class="conversation-scroll">
    @if (loading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading...</span>
      </div>
    } @else if (conversations.length === 0) {
      <div class="empty-state">
        <span class="material-icons-outlined">{{ getStatusIcon() }}</span>
        @if (reputationFilter || conversationFilter !== 'all') {
          <p>No chats match your filters</p>
          <button type="button" class="show-all-btn" (click)="clearFilters()">Clear filters</button>
        } @else {
          <p>No conversations yet</p>
        }
      </div>
    } @else {
      @for (conversation of conversations; track conversation.id) {
        <button 
          type="button"
          class="conversation-item"
          [class.active]="activeConversation?.id === conversation.id"
          [class.unread]="conversation.unreadCount > 0"
          [class.blocked]="conversation.isBlocked"
          (click)="onConversationClick(conversation)">
          <div class="conversation-avatar">
            @if (conversation.otherUser.photoURL) {
              <img [src]="conversation.otherUser.photoURL" [alt]="conversation.otherUser.displayName || 'User'" class="avatar-image">
            } @else {
              <span class="material-icons-outlined avatar-placeholder">person</span>
            }
            @if (conversation.isBlocked) {
              <span class="blocked-indicator" title="Blocked">
                <span class="material-icons-outlined">block</span>
              </span>
            } @else if (conversation.unreadCount > 0) {
              <span class="unread-indicator">{{ conversation.unreadCount > 9 ? '9+' : conversation.unreadCount }}</span>
            }
          </div>
          <div class="conversation-info">
            <div class="conversation-name-row">
              <span class="conversation-name">{{ conversation.otherUser.displayName || 'Unknown' }}</span>
              @if (shouldShowBadge(conversation.otherUser.reputationTier)) {
                <app-reputation-badge [tier]="getReputationTier(conversation.otherUser.reputationTier)" mode="icon" size="small"></app-reputation-badge>
              }
            </div>
            <span class="conversation-preview">
              @if (conversation.isBlocked) {
                <span class="blocked-text">Blocked</span>
              } @else {
                {{ conversation.lastMessage || 'New chat' }}
              }
            </span>
          </div>
          <span class="conversation-time">{{ formatTime(conversation.lastMessageTime) }}</span>
        </button>
      }
    }
  </div>

  <!-- Virtual Phone Card -->
  <app-virtual-phone-card
    [virtualPhone]="virtualPhone"
    [loading]="virtualPhoneLoading"
    [provisioning]="virtualPhoneProvisioning"
    [error]="virtualPhoneError"
    [isElite]="isElite"
    [hasVerifiedPhone]="hasVerifiedPhone"
    (copyNumber)="onVirtualPhoneCopy()"
    (openSettings)="onVirtualPhoneSettings()"
    (provision)="onVirtualPhoneProvision()"
    (showUpgrade)="onVirtualPhoneUpgrade()">
  </app-virtual-phone-card>
</aside>
