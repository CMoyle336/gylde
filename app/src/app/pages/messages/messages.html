<div class="messages-layout">
  <!-- Conversation List -->
  <aside class="conversation-list" [class.hidden-on-mobile]="activeConversation()">
    @if (loading()) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading...</span>
      </div>
    } @else if (conversations().length === 0) {
      <div class="empty-state">
        <span class="material-icons-outlined">chat_bubble_outline</span>
        <p>No conversations yet</p>
      </div>
    } @else {
      @for (conversation of conversations(); track conversation.id) {
        <button 
          type="button"
          class="conversation-item"
          [class.active]="activeConversation()?.id === conversation.id"
          [class.unread]="conversation.unreadCount > 0"
          (click)="openConversation(conversation)">
          <div class="conversation-avatar">
            @if (conversation.otherUser.photoURL) {
              <img [src]="conversation.otherUser.photoURL" [alt]="conversation.otherUser.displayName || 'User'" class="avatar-image">
            } @else {
              <span class="material-icons-outlined avatar-placeholder">person</span>
            }
            @if (conversation.unreadCount > 0) {
              <span class="unread-indicator"></span>
            }
          </div>
          <div class="conversation-info">
            <span class="conversation-name">{{ conversation.otherUser.displayName || 'Unknown' }}</span>
            <span class="conversation-preview">{{ conversation.lastMessage || 'New chat' }}</span>
          </div>
          <span class="conversation-time">{{ formatTime(conversation.lastMessageTime) }}</span>
        </button>
      }
    }
  </aside>

  <!-- Chat Area -->
  <main class="chat-area" [class.visible-on-mobile]="activeConversation()">
    @if (activeConversation()) {
      <!-- Mobile Back Button & User Info -->
      <header class="chat-header">
        <button type="button" class="back-btn" (click)="closeConversation()" aria-label="Back">
          <span class="material-icons-outlined">arrow_back</span>
        </button>
        <div class="chat-user">
          @if (activeConversation()!.otherUser.photoURL) {
            <img [src]="activeConversation()!.otherUser.photoURL" class="chat-avatar" [alt]="activeConversation()!.otherUser.displayName">
          } @else {
            <div class="chat-avatar placeholder">
              <span class="material-icons-outlined">person</span>
            </div>
          }
          <span class="chat-user-name">{{ activeConversation()!.otherUser.displayName || 'Unknown' }}</span>
        </div>
        <button type="button" class="options-btn" aria-label="Options">
          <span class="material-icons-outlined">more_vert</span>
        </button>
      </header>

      <!-- Messages -->
      <div class="messages-scroll" #messagesContainer>
        @if (messages().length === 0) {
          <div class="start-chat">
            <span class="material-icons-outlined">waving_hand</span>
            <p>Start the conversation!</p>
          </div>
        } @else {
          <div class="messages-list">
            @for (message of messages(); track message.id) {
              <div class="message" [class.own]="message.isOwn">
                <div class="bubble">
                  <p>{{ message.content }}</p>
                  <time>{{ formatMessageTime(message.createdAt) }}</time>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Input -->
      <footer class="chat-input">
        <input
          type="text"
          placeholder="Type a message..."
          [value]="messageInput()"
          (input)="messageInput.set($any($event.target).value)"
          (keydown)="onKeyDown($event)"
          [disabled]="sending()">
        <button 
          type="button"
          class="send-btn"
          [disabled]="!messageInput().trim() || sending()"
          (click)="sendMessage()">
          @if (sending()) {
            <div class="spinner"></div>
          } @else {
            <span class="material-icons-outlined">send</span>
          }
        </button>
      </footer>
    } @else {
      <!-- No chat selected (desktop only) -->
      <div class="no-chat">
        <span class="material-icons-outlined">forum</span>
        <h3>Select a conversation</h3>
        <p>Choose someone to chat with</p>
      </div>
    }
  </main>
</div>
