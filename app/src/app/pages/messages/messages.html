<div class="messages-layout">
  <!-- Conversation List -->
  <aside class="conversation-list" [class.hidden-on-mobile]="activeConversation()">
    @if (loading()) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading...</span>
      </div>
    } @else if (conversations().length === 0) {
      <div class="empty-state">
        <span class="material-icons-outlined">chat_bubble_outline</span>
        <p>No conversations yet</p>
      </div>
    } @else {
      @for (conversation of conversations(); track conversation.id) {
        <button 
          type="button"
          class="conversation-item"
          [class.active]="activeConversation()?.id === conversation.id"
          [class.unread]="conversation.unreadCount > 0"
          (click)="openConversation(conversation)">
          <div class="conversation-avatar">
            @if (conversation.otherUser.photoURL) {
              <img [src]="conversation.otherUser.photoURL" [alt]="conversation.otherUser.displayName || 'User'" class="avatar-image">
            } @else {
              <span class="material-icons-outlined avatar-placeholder">person</span>
            }
            @if (conversation.unreadCount > 0) {
              <span class="unread-indicator"></span>
            }
          </div>
          <div class="conversation-info">
            <span class="conversation-name">{{ conversation.otherUser.displayName || 'Unknown' }}</span>
            <span class="conversation-preview">{{ conversation.lastMessage || 'New chat' }}</span>
          </div>
          <span class="conversation-time">{{ formatTime(conversation.lastMessageTime) }}</span>
        </button>
      }
    }
  </aside>

  <!-- Chat Area -->
  <main class="chat-area" [class.visible-on-mobile]="activeConversation()">
    @if (activeConversation()) {
      <!-- Mobile Back Button & User Info -->
      <header class="chat-header">
        <button type="button" class="back-btn" (click)="closeConversation()" aria-label="Back">
          <span class="material-icons-outlined">arrow_back</span>
        </button>
        <div class="chat-user">
          @if (activeConversation()!.otherUser.photoURL) {
            <img [src]="activeConversation()!.otherUser.photoURL" class="chat-avatar" [alt]="activeConversation()!.otherUser.displayName">
          } @else {
            <div class="chat-avatar placeholder">
              <span class="material-icons-outlined">person</span>
            </div>
          }
          <span class="chat-user-name">{{ activeConversation()!.otherUser.displayName || 'Unknown' }}</span>
        </div>
        <button type="button" class="options-btn" aria-label="Options">
          <span class="material-icons-outlined">more_vert</span>
        </button>
      </header>

      <!-- Messages -->
      <div class="messages-scroll" cdkScrollable (scroll)="onScroll()">
        @if (messages().length === 0) {
          <div class="start-chat">
            <span class="material-icons-outlined">waving_hand</span>
            <p>Start the conversation!</p>
          </div>
        } @else {
          <div class="messages-list">
            @for (message of messages(); track message.id) {
              <div class="message" [class.own]="message.isOwn" [class.image-message]="message.type === 'image'" [class.deleted]="message.isDeletedForAll">
                
                <!-- Deleted for everyone placeholder -->
                @if (message.isDeletedForAll) {
                  <div class="bubble deleted-bubble">
                    <span class="material-icons-outlined deleted-icon">block</span>
                    <span class="deleted-text">{{ message.isOwn ? 'You deleted this message' : 'This message was deleted' }}</span>
                  </div>
                }
                <!-- Image message -->
                @else if (message.type === 'image' && message.imageUrls?.length) {
                  <div class="message-wrapper">
                    <div class="image-bubble">
                      <!-- Show text content if present (not a placeholder) -->
                      @if (message.content && !message.content.startsWith('Sent ')) {
                        <p class="image-caption">{{ message.content }}</p>
                      }
                      <div class="image-grid" [class.single]="message.imageUrls!.length === 1" [class.grid-2]="message.imageUrls!.length === 2" [class.grid-many]="message.imageUrls!.length > 2">
                        @for (imageUrl of message.imageUrls; track imageUrl; let idx = $index) {
                          <button type="button" class="image-item" (click)="openGallery(message.imageUrls!, idx, $event)">
                            <img [src]="imageUrl" alt="Shared image" loading="lazy">
                          </button>
                        }
                      </div>
                      <time>{{ formatMessageTime(message.createdAt) }}</time>
                    </div>
                    <!-- Message actions menu -->
                    <button type="button" class="message-menu-btn" [matMenuTriggerFor]="messageMenu">
                      <span class="material-icons-outlined">more_vert</span>
                    </button>
                    <mat-menu #messageMenu="matMenu" class="message-actions-menu">
                      <button mat-menu-item (click)="deleteForMe(message)">
                        <span class="material-icons-outlined">delete</span>
                        <span>Delete for me</span>
                      </button>
                      @if (message.isOwn) {
                        <button mat-menu-item (click)="deleteForEveryone(message)" class="delete-everyone">
                          <span class="material-icons-outlined">delete_forever</span>
                          <span>Delete for everyone</span>
                        </button>
                      }
                    </mat-menu>
                  </div>
                }
                <!-- Text message -->
                @else {
                  <div class="message-wrapper">
                    <div class="bubble">
                      <p>{{ message.content }}</p>
                      <time>{{ formatMessageTime(message.createdAt) }}</time>
                    </div>
                    <!-- Message actions menu -->
                    <button type="button" class="message-menu-btn" [matMenuTriggerFor]="messageMenu">
                      <span class="material-icons-outlined">more_vert</span>
                    </button>
                    <mat-menu #messageMenu="matMenu" class="message-actions-menu">
                      <button mat-menu-item (click)="deleteForMe(message)">
                        <span class="material-icons-outlined">delete</span>
                        <span>Delete for me</span>
                      </button>
                      @if (message.isOwn) {
                        <button mat-menu-item (click)="deleteForEveryone(message)" class="delete-everyone">
                          <span class="material-icons-outlined">delete_forever</span>
                          <span>Delete for everyone</span>
                        </button>
                      }
                    </mat-menu>
                  </div>
                }
              </div>
            }
            
            <!-- Typing Indicator -->
            @if (isOtherUserTyping()) {
              <div class="message typing-indicator">
                <div class="bubble typing-bubble">
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Input Area -->
      <footer class="chat-input-area">
        <!-- Image Previews (inline with input) -->
        @if (selectedImages().length > 0) {
          <div class="image-preview-row">
            <div class="image-previews">
              @for (image of selectedImages(); track image.url; let i = $index) {
                <div class="preview-item">
                  <img [src]="image.url" alt="Selected image">
                  <button type="button" class="remove-preview" (click)="removeImage(i)" aria-label="Remove image">
                    <span class="material-icons-outlined">close</span>
                  </button>
                </div>
              }
            </div>
            @if (selectedImages().length > 1) {
              <button type="button" class="clear-all-btn" (click)="clearImages()">
                <span class="material-icons-outlined">close</span>
                Clear all
              </button>
            }
          </div>
        }

        <!-- Input Row -->
        <div class="chat-input">
          <!-- Hidden file input -->
          <input 
            #fileInput
            type="file" 
            accept="image/*" 
            multiple 
            hidden 
            (change)="onFilesSelected($event)">
          
          <!-- Image upload button -->
          <button 
            type="button" 
            class="attach-btn"
            (click)="openImagePicker()"
            [disabled]="sending()"
            aria-label="Attach images">
            <span class="material-icons-outlined">image</span>
          </button>

          <input
            type="text"
            placeholder="Type a message..."
            [value]="messageInput()"
            (input)="messageInput.set($any($event.target).value); onInput()"
            (keydown)="onKeyDown($event)"
            [disabled]="sending()">
          <button 
            type="button"
            class="send-btn"
            [disabled]="!canSend() || sending()"
            (click)="send()">
            @if (sending()) {
              <div class="spinner"></div>
            } @else {
              <span class="material-icons-outlined">send</span>
            }
          </button>
        </div>
      </footer>
    } @else {
      <!-- No chat selected (desktop only) -->
      <div class="no-chat">
        <span class="material-icons-outlined">forum</span>
        <h3>Select a conversation</h3>
        <p>Choose someone to chat with</p>
      </div>
    }
  </main>
</div>

<!-- Image Gallery Lightbox -->
@if (gallery().isOpen) {
  <div class="gallery-overlay" (click)="closeGallery()">
    <div class="gallery-container" (click)="$event.stopPropagation()">
      <!-- Close Button -->
      <button type="button" class="gallery-close" (click)="closeGallery()" aria-label="Close gallery">
        <span class="material-icons-outlined">close</span>
      </button>

      <!-- Navigation: Previous -->
      @if (gallery().images.length > 1) {
        <button type="button" class="gallery-nav prev" (click)="prevImage()" aria-label="Previous image">
          <span class="material-icons-outlined">chevron_left</span>
        </button>
      }

      <!-- Main Image -->
      <div class="gallery-image-wrapper">
        <img [ngSrc]="gallery().images[gallery().currentIndex]" alt="Image" class="gallery-image" fill priority>
      </div>

      <!-- Navigation: Next -->
      @if (gallery().images.length > 1) {
        <button type="button" class="gallery-nav next" (click)="nextImage()" aria-label="Next image">
          <span class="material-icons-outlined">chevron_right</span>
        </button>
      }

      <!-- Image Counter -->
      @if (gallery().images.length > 1) {
        <div class="gallery-counter">
          {{ gallery().currentIndex + 1 }} / {{ gallery().images.length }}
        </div>
      }

      <!-- Thumbnail Strip -->
      @if (gallery().images.length > 1) {
        <div class="gallery-thumbnails">
          @for (img of gallery().images; track img; let i = $index) {
            <button 
              type="button" 
              class="thumbnail" 
              [class.active]="i === gallery().currentIndex"
              (click)="goToImage(i)">
              <img [ngSrc]="img" alt="Thumbnail" width="60" height="60">
            </button>
          }
        </div>
      }
    </div>
  </div>
}
