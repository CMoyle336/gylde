<div class="messages-layout" [class.ai-panel-open]="isAiPanelOpen()">
  <!-- Conversation List -->
  <app-conversation-list
    [conversations]="conversations()"
    [activeConversation]="activeConversation()"
    [loading]="loading()"
    [conversationFilter]="conversationFilter()"
    [totalUnreadCount]="totalUnreadCount()"
    [archivedCount]="archivedCount()"
    [virtualPhone]="virtualPhone()"
    [virtualPhoneLoading]="virtualPhoneLoading()"
    [virtualPhoneProvisioning]="virtualPhoneProvisioning()"
    [virtualPhoneError]="virtualPhoneError()"
    [isElite]="subscriptionService.isElite()"
    [hasVerifiedPhone]="hasVerifiedPhone()"
    (conversationSelected)="onConversationSelected($event)"
    (filterChanged)="onFilterChanged($event)"
    (virtualPhoneCopy)="onVirtualPhoneCopy()"
    (virtualPhoneSettings)="onVirtualPhoneSettings()"
    (virtualPhoneProvision)="onVirtualPhoneProvision()"
    (virtualPhoneUpgrade)="onVirtualPhoneUpgrade()">
  </app-conversation-list>

  <!-- Chat Area -->
  <main class="chat-area" [class.visible-on-mobile]="activeConversation()">
    @if (activeConversation()) {
      <!-- Chat Header -->
      <app-chat-header
        [conversation]="activeConversation()"
        [otherUserStatus]="otherUserStatus()"
        [isTyping]="isOtherUserTyping()"
        [isBlocked]="isOtherUserBlocked()"
        [hasVirtualPhone]="!!virtualPhone()"
        (backClicked)="onBackClicked()"
        (viewProfile)="onViewProfile()"
        (archiveChat)="onArchiveChat()"
        (unarchiveChat)="onUnarchiveChat()"
        (shareNumber)="onShareNumber()">
      </app-chat-header>

      <!-- Messages with Virtual Scrolling -->
      @if (messages().length === 0) {
        <div class="messages-scroll empty-state">
          <div class="start-chat">
            <span class="material-icons-outlined">waving_hand</span>
            <p>Start the conversation!</p>
          </div>
        </div>
      } @else {
        <div class="messages-scroll">
          <!-- Loading older messages indicator -->
          @if (loadingOlderMessages()) {
            <div class="loading-older">
              <div class="loading-spinner small"></div>
              <span>Loading older messages...</span>
            </div>
          } @else if (hasOlderMessages()) {
            <div class="load-more-hint">
              <span class="material-icons-outlined">expand_less</span>
              <span>Scroll up for more</span>
            </div>
          }
          
          <!-- Confirmed messages in virtual scroll -->
          <div *uiScroll="let message of messageDatasource; let i = index; let isLast = last">
            <app-message-bubble
              [message]="message"
              [senderCountdown]="getSenderCountdown(message.id)"
              [recipientCountdown]="getRecipientCountdown(message.id)"
              [isLast]="isLast && pendingMessages().length === 0"
              (openGallery)="onOpenGallery($event)"
              (deleteForMe)="onDeleteForMe($event)"
              (deleteForEveryone)="onDeleteForEveryone($event)">
            </app-message-bubble>
          </div>
          
          <!-- Pending messages (being sent) - shown outside virtual scroll -->
          @for (message of pendingMessages(); track message.id; let isLast = $last) {
            <app-message-bubble
              [message]="message"
              [senderCountdown]="null"
              [recipientCountdown]="null"
              [isLast]="isLast"
              (openGallery)="onOpenGallery($event)"
              (deleteForMe)="onDeleteForMe($event)"
              (deleteForEveryone)="onDeleteForEveryone($event)">
            </app-message-bubble>
          }
        </div>
      }

      <!-- Chat Input -->
      <app-chat-input
        [isBlocked]="isOtherUserBlocked()"
        [isAiPanelOpen]="isAiPanelOpen()"
        [hasAiAccess]="hasAiAccess()"
        (messageSent)="onMessageSent($event)"
        (typing)="onTyping()"
        (aiAssistToggled)="onAiAssistToggled()">
      </app-chat-input>
    } @else {
      <!-- No chat selected (desktop only) -->
      <div class="no-chat">
        <span class="material-icons-outlined">forum</span>
        <h3>Select a conversation</h3>
        <p>Choose someone to chat with</p>
      </div>
    }
  </main>

  <!-- AI Assist Panel -->
  @if (isAiPanelOpen() && activeConversation()) {
    <aside class="ai-assist-sidebar">
      <app-ai-assist-panel
        [context]="aiAssistContext()"
        (insertText)="onAiInsertText($event)"
        (closed)="onAiPanelClosed()">
      </app-ai-assist-panel>
    </aside>
  }
</div>

<!-- Image Gallery Lightbox -->
<app-image-gallery
  [gallery]="gallery()"
  [countdown]="galleryCountdown()"
  (closed)="onGalleryClosed()"
  (navigated)="onGalleryNavigated($event)">
</app-image-gallery>

<!-- Virtual Phone Settings Dialog -->
<app-virtual-phone-settings
  [isOpen]="showVirtualPhoneSettings()"
  [virtualPhone]="virtualPhone()"
  [provisioning]="virtualPhoneProvisioning()"
  [error]="virtualPhoneError()"
  (closed)="onVirtualPhoneSettingsClosed()"
  (settingChanged)="onVirtualPhoneSettingChanged($event)"
  (released)="onVirtualPhoneReleased()">
</app-virtual-phone-settings>
