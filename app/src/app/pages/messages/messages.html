<div class="messages-layout" [class.ai-panel-open]="isAiPanelOpen()">
  <!-- Conversation List -->
  <app-conversation-list
    [conversations]="conversations()"
    [activeConversation]="activeConversation()"
    [loading]="loading()"
    [conversationFilter]="conversationFilter()"
    [reputationFilter]="reputationFilter()"
    [totalUnreadCount]="totalUnreadCount()"
    [archivedCount]="archivedCount()"
    [virtualPhone]="virtualPhone()"
    [virtualPhoneLoading]="virtualPhoneLoading()"
    [virtualPhoneProvisioning]="virtualPhoneProvisioning()"
    [virtualPhoneError]="virtualPhoneError()"
    [isPremium]="subscriptionService.isPremium()"
    [hasVerifiedPhone]="hasVerifiedPhone()"
    (conversationSelected)="onConversationSelected($event)"
    (filterChanged)="onFilterChanged($event)"
    (reputationFilterChanged)="onReputationFilterChanged($event)"
    (virtualPhoneCopy)="onVirtualPhoneCopy()"
    (virtualPhoneSettings)="onVirtualPhoneSettings()"
    (virtualPhoneProvision)="onVirtualPhoneProvision()"
    (virtualPhoneUpgrade)="onVirtualPhoneUpgrade()">
  </app-conversation-list>

  <!-- Chat Area -->
  <main class="chat-area" [class.visible-on-mobile]="activeConversation()">
    @if (activeConversation()) {
      <!-- Chat Header -->
      <app-chat-header
        [conversation]="activeConversation()"
        [otherUserStatus]="otherUserStatus()"
        [isTyping]="isOtherUserTyping()"
        [isBlocked]="isOtherUserBlocked()"
        [hasVirtualPhone]="!!virtualPhone()"
        (backClicked)="onBackClicked()"
        (viewProfile)="onViewProfile()"
        (archiveChat)="onArchiveChat()"
        (unarchiveChat)="onUnarchiveChat()"
        (shareNumber)="onShareNumber()"
        (blockUser)="onBlockUser()"
        (reportUser)="onReportUser()">
      </app-chat-header>

      <!-- Upgrade Prompt for Free Users -->
      @if (!hasMessagingAccess()) {
        <div class="upgrade-prompt">
          <div class="upgrade-content">
            <span class="material-icons-outlined upgrade-icon">lock</span>
            <h3>{{ 'MESSAGES.UPGRADE_TITLE' | translate }}</h3>
            <p>{{ 'MESSAGES.UPGRADE_DESCRIPTION' | translate }}</p>
            <button class="upgrade-btn" (click)="onUpgradeClicked()">
              <span class="material-icons-outlined">arrow_upward</span>
              {{ 'MESSAGES.VIEW_PLANS_BUTTON' | translate }}
            </button>
          </div>
        </div>
      } @else {
        <!-- Messages with Virtual Scrolling -->
        @if (messages().length === 0) {
          <div class="messages-scroll empty-state">
            <div class="start-chat">
              <span class="material-icons-outlined">waving_hand</span>
              <p>{{ 'MESSAGES.START_CONVERSATION' | translate }}</p>
            </div>
          </div>
        } @else {
        <div class="messages-scroll">
          <!-- Loading older messages indicator -->
          @if (loadingOlderMessages()) {
            <div class="loading-older">
              <div class="loading-spinner small"></div>
              <span>{{ 'MESSAGES.LOADING_OLDER' | translate }}</span>
            </div>
          } @else if (hasOlderMessages()) {
            <div class="load-more-hint">
              <span class="material-icons-outlined">expand_less</span>
              <span>{{ 'MESSAGES.SCROLL_UP_HINT' | translate }}</span>
            </div>
          }
          
          <!-- Confirmed messages in virtual scroll -->
          <div *uiScroll="let message of messageDatasource; let i = index; let isLast = last">
            <app-message-bubble
              [message]="message"
              [senderCountdown]="getSenderCountdown(message.id)"
              [recipientCountdown]="getRecipientCountdown(message.id)"
              [isLast]="isLast && pendingMessages().length === 0"
              [showReadReceipts]="showReadReceipts()"
              (openGallery)="onOpenGallery($event)"
              (openVideo)="onOpenVideo($event)"
              (deleteForMe)="onDeleteForMe($event)"
              (deleteForEveryone)="onDeleteForEveryone($event)">
            </app-message-bubble>
          </div>
          
          <!-- Pending messages (being sent) - shown outside virtual scroll -->
          @for (message of pendingMessages(); track message.id; let isLast = $last) {
            <app-message-bubble
              [message]="message"
              [senderCountdown]="null"
              [recipientCountdown]="null"
              [isLast]="isLast"
              [showReadReceipts]="showReadReceipts()"
              (openGallery)="onOpenGallery($event)"
              (openVideo)="onOpenVideo($event)"
              (deleteForMe)="onDeleteForMe($event)"
              (deleteForEveryone)="onDeleteForEveryone($event)">
            </app-message-bubble>
          }
        </div>
        }

        <!-- Message Restriction Alert (replaces chat input when blocked) -->
        @if (messageBlocked(); as blocked) {
          <div class="message-restriction-alert">
            <span class="material-icons-outlined alert-icon">
              @switch (blocked.reason) {
                @case ('daily_limit_reached') { schedule }
                @case ('tier_restriction') { trending_up }
                @case ('blocked') { block }
                @default { warning }
              }
            </span>
            <div class="alert-content">
              @switch (blocked.reason) {
                @case ('daily_limit_reached') {
                  <h4>{{ 'MESSAGES.RESTRICTION.DAILY_LIMIT_TITLE' | translate }}</h4>
                  <p>{{ 'MESSAGES.RESTRICTION.DAILY_LIMIT_DESC' | translate }}</p>
                }
                @case ('tier_restriction') {
                  <h4>{{ 'MESSAGES.RESTRICTION.TIER_TITLE' | translate }}</h4>
                  <p>{{ 'MESSAGES.RESTRICTION.TIER_DESC' | translate }}</p>
                }
                @case ('blocked') {
                  <h4>{{ 'MESSAGES.RESTRICTION.BLOCKED_TITLE' | translate }}</h4>
                  <p>{{ 'MESSAGES.RESTRICTION.BLOCKED_DESC' | translate }}</p>
                }
                @default {
                  <h4>{{ 'MESSAGES.RESTRICTION.DEFAULT_TITLE' | translate }}</h4>
                  <p>{{ 'MESSAGES.RESTRICTION.DEFAULT_DESC' | translate }}</p>
                }
              }
            </div>
          </div>
        } @else {
          <!-- Message Limit Warning (when running low but not blocked) -->
          <!-- Don't show warning for unlimited (-1) or when not running low -->
          @if (remainingMessages(); as remaining) {
            @if (remaining > 0 && remaining <= 3) {
              <div class="message-limit-warning">
                <span class="material-icons-outlined">info</span>
                <span>{{ 'MESSAGES.REMAINING_MESSAGES' | translate:{ count: remaining } }}</span>
              </div>
            }
          }

          <!-- Chat Input -->
          <app-chat-input
            [isBlocked]="isOtherUserBlocked()"
            [isAiPanelOpen]="isAiPanelOpen()"
            [hasAiAccess]="hasAiAccess()"
            (messageSent)="onMessageSent($event)"
            (videoSent)="onVideoSent($event)"
            (typing)="onTyping()"
            (draftChanged)="onDraftChanged($event)"
            (aiAssistToggled)="onAiAssistToggled()">
          </app-chat-input>
        }
      }
    } @else {
      <!-- No chat selected (desktop only) -->
      <div class="no-chat">
        <span class="material-icons-outlined">forum</span>
        <h3>{{ 'MESSAGES.NO_CHAT_SELECTED_TITLE' | translate }}</h3>
        <p>{{ 'MESSAGES.NO_CHAT_SELECTED_SUBTITLE' | translate }}</p>
      </div>
    }
  </main>

  <!-- AI Assist Panel -->
  @if (isAiPanelOpen() && activeConversation()) {
    <aside class="ai-assist-sidebar">
      <app-ai-assist-panel
        [context]="aiAssistContext()"
        (insertText)="onAiInsertText($event)"
        (closed)="onAiPanelClosed()">
      </app-ai-assist-panel>
    </aside>
  }
</div>

<!-- Image Gallery Lightbox -->
<app-image-gallery
  [gallery]="gallery()"
  [countdown]="galleryCountdown()"
  (closed)="onGalleryClosed()"
  (navigated)="onGalleryNavigated($event)">
</app-image-gallery>

<!-- Video Player Modal -->
<app-video-player
  [video]="videoPlayer()"
  (closed)="onVideoClosed()">
</app-video-player>

<!-- Virtual Phone Settings Dialog -->
<app-virtual-phone-settings
  [isOpen]="showVirtualPhoneSettings()"
  [virtualPhone]="virtualPhone()"
  [provisioning]="virtualPhoneProvisioning()"
  [error]="virtualPhoneError()"
  (closed)="onVirtualPhoneSettingsClosed()"
  (settingChanged)="onVirtualPhoneSettingChanged($event)"
  (released)="onVirtualPhoneReleased()">
</app-virtual-phone-settings>
