<div class="private-access-dialog">
  <div class="dialog-header">
    <div class="header-content">
      <mat-icon class="header-icon">lock</mat-icon>
      <h2>{{ 'PRIVATE_ACCESS.REQUEST_TITLE' | translate }}</h2>
    </div>
    <button mat-icon-button class="close-btn" (click)="close()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content>
    @if (error()) {
      <div class="error-message">
        <mat-icon>error_outline</mat-icon>
        {{ error() }}
      </div>
    }

    @if (request(); as req) {
      <!-- Success State (after action taken) -->
      @if (completed()) {
        <div class="success-state">
          <div class="success-icon" [class.denied]="completed() === 'denied'">
            <mat-icon>{{ completed() === 'granted' ? 'check_circle' : 'cancel' }}</mat-icon>
          </div>
          <h3>{{ completed() === 'granted' ? ('PRIVATE_ACCESS.ACCESS_GRANTED' | translate) : ('PRIVATE_ACCESS.REQUEST_DENIED' | translate) }}</h3>
          <p>
            @if (completed() === 'granted') {
              {{ req.requesterName }} {{ 'PRIVATE_ACCESS.CAN_NOW_VIEW' | translate }}
            } @else {
              {{ 'PRIVATE_ACCESS.DENIED_MESSAGE' | translate }}
            }
          </p>
        </div>
      } @else if (!isPending()) {
        <!-- Already Handled State -->
        <div class="already-handled-state">
          <div class="request-card compact">
            <a [routerLink]="['/user', req.id]" class="user-avatar" (click)="close()">
              <img [src]="req.requesterPhoto || 'assets/default-avatar.png'" 
                   [alt]="req.requesterName">
            </a>
            <div class="user-info">
              <a [routerLink]="['/user', req.id]" class="user-name" (click)="close()">
                {{ req.requesterName }}
              </a>
            </div>
          </div>
          
          <div class="handled-message">
            <mat-icon>check_circle</mat-icon>
            <p>{{ 'PRIVATE_ACCESS.ALREADY_HANDLED' | translate }}</p>
          </div>

          <p class="manage-hint">
            <a routerLink="/profile" (click)="close()">{{ 'PRIVATE_ACCESS.MANAGE_ALL_LINK' | translate }}</a>
          </p>
        </div>
      } @else {
        <!-- Pending Request - Show approve/deny options -->
        <div class="request-card">
          <a [routerLink]="['/user', req.id]" class="user-avatar" (click)="close()">
            <img [src]="req.requesterPhoto || 'assets/default-avatar.png'" 
                 [alt]="req.requesterName">
          </a>
          <div class="user-info">
            <a [routerLink]="['/user', req.id]" class="user-name" (click)="close()">
              {{ req.requesterName }}
            </a>
            <span class="request-time">{{ 'PRIVATE_ACCESS.REQUESTED' | translate }} {{ formatTimeAgo(req.requestedAt) }}</span>
          </div>
        </div>

        <p class="request-description">{{ 'PRIVATE_ACCESS.REQUEST_DESCRIPTION' | translate }}</p>

        <!-- Action Buttons -->
        <div class="action-buttons">
          @if (processing()) {
            <div class="processing-state">
              <mat-spinner diameter="32"></mat-spinner>
            </div>
          } @else {
            <button class="action-btn deny" (click)="denyAccess()">
              <mat-icon>close</mat-icon>
              {{ 'PRIVATE_ACCESS.DENY_BUTTON' | translate }}
            </button>
            <button class="action-btn approve" (click)="grantAccess()">
              <mat-icon>check</mat-icon>
              {{ 'PRIVATE_ACCESS.GRANT_BUTTON' | translate }}
            </button>
          }
        </div>

        <p class="manage-hint">
          <a routerLink="/profile" (click)="close()">{{ 'PRIVATE_ACCESS.MANAGE_ALL_LINK' | translate }}</a>
        </p>
      }
    }
  </mat-dialog-content>
</div>
