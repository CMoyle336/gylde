<div class="comments-dialog">
  <!-- Header -->
  <header class="dialog-header">
    <h2>{{ data.post.author.displayName || 'User' }}'s Post</h2>
    <button 
      type="button" 
      mat-icon-button 
      class="close-btn" 
      (click)="close()"
      [attr.aria-label]="'COMMON.CLOSE' | translate">
      <mat-icon>close</mat-icon>
    </button>
  </header>

  <!-- Scrollable Content Area -->
  <div class="dialog-content">
    <!-- Post Content -->
    <article class="post-section">
      <div class="post-author">
        <app-reputation-avatar
          [photoURL]="data.post.author.photoURL"
          [displayName]="data.post.author.displayName"
          [reputationTier]="data.post.author.reputationTier"
          size="medium" />
        <div class="author-info">
          <span class="author-name">
            {{ data.post.author.displayName || ('FEED.ANONYMOUS_USER' | translate) }}
            @if (data.post.author.isVerified) {
              <mat-icon class="verified-badge">verified</mat-icon>
            }
          </span>
          <span class="post-time">{{ formatDate(data.post.createdAt) }}</span>
        </div>
      </div>

      <!-- Post Text -->
      @if (data.post.content.text) {
        <p class="post-text">{{ data.post.content.text }}</p>
      }

      <!-- Post Media -->
      @if (data.post.content.media && data.post.content.media.length > 0) {
        @let mediaCount = data.post.content.media.length;
        <div class="post-media" [class.single]="mediaCount === 1" [class.multi]="mediaCount > 1">
          @for (media of data.post.content.media; track $index) {
            <div class="media-item" [class.single-item]="mediaCount === 1">
              @if (isVideoMedia(media)) {
                <video 
                  [src]="media.url" 
                  controls 
                  preload="metadata"
                  playsinline
                  class="media-video">
                </video>
              } @else {
                <img 
                  [src]="media.url" 
                  [alt]="'Post media'" 
                  class="media-image clickable-image"
                  (click)="openGallery(media.url)">
              }
            </div>
          }
        </div>
      }

      <!-- Post Stats -->
      <div class="post-stats">
        <span class="stat">
          <mat-icon>favorite</mat-icon>
          {{ data.post.likeCount }}
        </span>
        <span class="stat">
          <mat-icon>chat_bubble</mat-icon>
          {{ data.post.commentCount }}
        </span>
      </div>
    </article>

    <!-- Divider -->
    <div class="section-divider"></div>

    <!-- Comments Section -->
    <section class="comments-section">
      <h3 class="comments-heading">{{ 'FEED.COMMENTS_TITLE' | translate }}</h3>

      @if (loading()) {
        <div class="loading-state">
          <mat-spinner diameter="32"></mat-spinner>
        </div>
      } @else if (topLevelComments().length === 0) {
        <div class="empty-state">
          <mat-icon>chat_bubble_outline</mat-icon>
          <p>{{ 'FEED.NO_COMMENTS' | translate }}</p>
          <span>{{ 'FEED.BE_FIRST_COMMENT' | translate }}</span>
        </div>
      } @else {
        <div class="comments-list">
          @for (comment of topLevelComments(); track comment.id) {
            <!-- Top-level comment -->
            <article class="comment-item">
              <app-reputation-avatar
                [photoURL]="comment.author.photoURL"
                [displayName]="comment.author.displayName"
                [reputationTier]="comment.author.reputationTier"
                size="small" />

              <div class="comment-content">
                <!-- Bubble row with options button -->
                <div class="bubble-row">
                  <div class="comment-bubble">
                    <span class="comment-author">
                      {{ comment.author.displayName || ('FEED.ANONYMOUS_USER' | translate) }}
                    </span>
                    <p class="comment-text">{{ comment.content }}</p>
                  </div>

                  <!-- Options menu - to the right of bubble -->
                  <button 
                    type="button" 
                    mat-icon-button
                    [matMenuTriggerFor]="commentMenu"
                    class="comment-options">
                    <mat-icon>more_horiz</mat-icon>
                  </button>

                  <mat-menu #commentMenu="matMenu">
                    @if (comment.isOwn) {
                      <button mat-menu-item (click)="deleteComment(comment)">
                        <mat-icon>delete</mat-icon>
                        <span>{{ 'FEED.DELETE_COMMENT' | translate }}</span>
                      </button>
                    } @else {
                      <button mat-menu-item (click)="reportComment(comment)">
                        <mat-icon>flag</mat-icon>
                        <span>{{ 'FEED.REPORT_COMMENT' | translate }}</span>
                      </button>
                      <button mat-menu-item (click)="blockUser(comment)">
                        <mat-icon>block</mat-icon>
                        <span>{{ 'FEED.BLOCK_USER' | translate }}</span>
                      </button>
                    }
                  </mat-menu>
                </div>

                <!-- Actions row: time, like, reply, like count -->
                <div class="comment-actions">
                  <span class="comment-time">{{ formatDate(comment.createdAt) }}</span>
                  <button 
                    type="button" 
                    class="action-btn" 
                    [class.liked]="comment.isLiked"
                    (click)="toggleLike(comment)">
                    {{ 'FEED.LIKE' | translate }}
                  </button>
                  <button 
                    type="button" 
                    class="action-btn"
                    (click)="startReply(comment)">
                    {{ 'FEED.REPLY' | translate }}
                  </button>
                  @if (comment.likeCount > 0) {
                    <span class="like-count">
                      <mat-icon>favorite</mat-icon>
                      {{ comment.likeCount }}
                    </span>
                  }
                </div>

                <!-- Nested replies -->
                @if (getReplies(comment.id).length > 0) {
                  <div class="replies-section">
                    @for (reply of getReplies(comment.id); track reply.id) {
                      <article class="comment-item reply">
                        <app-reputation-avatar
                          [photoURL]="reply.author.photoURL"
                          [displayName]="reply.author.displayName"
                          [reputationTier]="reply.author.reputationTier"
                          size="small" />

                        <div class="comment-content">
                          <!-- Bubble row with options button -->
                          <div class="bubble-row">
                            <div class="comment-bubble">
                              <span class="comment-author">
                                {{ reply.author.displayName || ('FEED.ANONYMOUS_USER' | translate) }}
                              </span>
                              <p class="comment-text">{{ reply.content }}</p>
                            </div>

                            <!-- Options menu - to the right of bubble -->
                            <button 
                              type="button" 
                              mat-icon-button
                              [matMenuTriggerFor]="replyMenu"
                              class="comment-options">
                              <mat-icon>more_horiz</mat-icon>
                            </button>

                            <mat-menu #replyMenu="matMenu">
                              @if (reply.isOwn) {
                                <button mat-menu-item (click)="deleteComment(reply)">
                                  <mat-icon>delete</mat-icon>
                                  <span>{{ 'FEED.DELETE_COMMENT' | translate }}</span>
                                </button>
                              } @else {
                                <button mat-menu-item (click)="reportComment(reply)">
                                  <mat-icon>flag</mat-icon>
                                  <span>{{ 'FEED.REPORT_COMMENT' | translate }}</span>
                                </button>
                                <button mat-menu-item (click)="blockUser(reply)">
                                  <mat-icon>block</mat-icon>
                                  <span>{{ 'FEED.BLOCK_USER' | translate }}</span>
                                </button>
                              }
                            </mat-menu>
                          </div>

                          <div class="comment-actions">
                            <span class="comment-time">{{ formatDate(reply.createdAt) }}</span>
                            <button 
                              type="button" 
                              class="action-btn" 
                              [class.liked]="reply.isLiked"
                              (click)="toggleLike(reply)">
                              {{ 'FEED.LIKE' | translate }}
                            </button>
                            <button 
                              type="button" 
                              class="action-btn"
                              (click)="startReply(comment, reply.author.displayName || undefined)">
                              {{ 'FEED.REPLY' | translate }}
                            </button>
                            @if (reply.likeCount > 0) {
                              <span class="like-count">
                                <mat-icon>favorite</mat-icon>
                                {{ reply.likeCount }}
                              </span>
                            }
                          </div>
                        </div>
                      </article>
                    }
                  </div>
                }
              </div>
            </article>
          }
        </div>
      }
    </section>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <div class="error-message">
      <mat-icon>error</mat-icon>
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Fixed Comment Input -->
  <footer class="comment-input-section">
    <!-- Reply indicator -->
    @if (replyingTo()) {
      <div class="reply-indicator">
        <span>{{ 'FEED.REPLYING_TO' | translate }} <strong>{{ replyingTo()?.author?.displayName }}</strong></span>
        <button type="button" mat-icon-button (click)="cancelReply()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    }
    
    <div class="input-row">
      <div class="current-user-avatar">
        <mat-icon>person</mat-icon>
      </div>
      <div class="comment-input-wrapper">
        <input
          #commentInput
          type="text"
          class="comment-input"
          [placeholder]="replyingTo() ? ('FEED.WRITE_REPLY_PLACEHOLDER' | translate) : ('FEED.ADD_COMMENT_PLACEHOLDER' | translate)"
          [(ngModel)]="commentText"
          [maxlength]="maxCommentLength"
          (keydown.enter)="submitComment()">
        
        <button
          type="button"
          class="send-btn"
          [disabled]="!canSubmit"
          (click)="submitComment()">
          @if (submitting()) {
            <mat-spinner diameter="18"></mat-spinner>
          } @else {
            <mat-icon>send</mat-icon>
          }
        </button>
      </div>
    </div>
  </footer>
</div>

<!-- Image Gallery -->
<app-image-gallery
  [gallery]="galleryState()"
  (closed)="closeGallery()"
  (navigated)="navigateGallery($event)" />
