rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Activities collection - users can only access their own activities
    match /activities/{activityId} {
      // For list queries, Firebase requires the query to filter by userId
      // For single doc reads, check resource.data.userId
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Favorites collection
    match /favorites/{favoriteId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Deleted messages archive (admin-only read, user can create when deleting)
    match /deletedMessages/{archiveId} {
      // Only admins can read archived/deleted messages
      allow read: if request.auth != null && request.auth.token.admin == true;
      // Users can archive their own deleted messages
      allow create: if request.auth != null && request.auth.uid == request.resource.data.deletedBy;
    }
    
    // Conversations collection
    match /conversations/{conversationId} {
      // Only participants can read/write conversations
      allow read: if request.auth != null && request.auth.uid in resource.data.participants;
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participants;
      allow update: if request.auth != null && request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Only conversation participants can read messages
        allow read: if request.auth != null 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        
        // Only participants can create messages
        allow create: if request.auth != null 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
          && request.resource.data.senderId == request.auth.uid;
        
        // Update rules for deletion and read status
        allow update: if request.auth != null 
          && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }
    
    // Fallback for development - remove in production
    match /{document=**} {
      allow read, write: if request.time < timestamp.date(2026, 2, 9);
    }
  }
}
